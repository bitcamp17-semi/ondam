<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drive Storage</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/index.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">안녕하세요 <span id="userName">name</span>님!</div>
            <div class="navbar">
                <div id="navlist2">오늘은 <span id="todayDate">date</span> <span id="todayWeekday">요일</span> 입니다!</div>
            </div>
        </div>
        <div class="section">
            <div class="left">
                <div class="lefttop">
                    <img id="profileImage"
                         th:src="@{/images/Rectangle53.png}"
                         onerror="this.onerror=null; this.src='/images/Rectangle53.png';"
                         alt="프로필 이미지" />

                    <div class="profileinfo" id="profileInfo">
                        <div><span>이름</span><span id="infoName">홍길동</span></div>
                        <div><span>직급</span><span id="infoPosition">대리</span></div>
                        <div><span>부서</span><span id="infoDepartment">개발팀</span></div>
                        <div><span>번호</span><span id="infoPhone">010-1234-5678</span></div>
                    </div>

                    <button class="whitebtn" id="editUserBtn">개인정보 수정하기</button>
                </div>
                <div class="leftmiddle">
                    <span>공지사항</span>
                    <div class="notice">
                        <span>[공지] 제목입니다</span>
                        <a>등록일</a>
                    </div>
                    <div class="notice">
                        <span>[공지] 제목입니다</span>
                        <a>등록일</a>
                    </div>
                </div>
                <div class="leftbottom">
                    <span>전자결재</span>
                    <div class="approvalmini">
                        <div class="approvalcontent" th:data-url="@{/draft/approvalInbox}">
                            <span>결재할 문서</span>
                            <a>7</a>
                        </div>
                        <div class="approvalcontent" th:data-url="@{/draft/approvalOutBox}">
                            <span>진행중 문서</span>
                            <a>7</a>
                        </div>
                        <div class="approvalcontent" th:data-url="@{/draft/approvalOutBox}">
                            <span>진행중 문서</span>
                            <a>7</a>
                        </div>
                        <div class="approvalcontent" th:data-url="@{/draft/approvalOutBox}">
                            <span>대기중 문서</span>
                            <a>7</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="middle">
                달력
            </div>
            <div class="right">
                <div id="weather-today" class="weather-today"></div>
                <div id="weather-week" class="weather-cards"></div>
            </div>
        </div>
    </div>
</div>
<!-- 모달 HTML -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
        <h2>개인정보 수정</h2>
        <div class="modaltitle">
            <span>이메일</span>
            <input type="text" class="modaltitlebox" id="modalEmail">
        </div>
        <div class="modaltitle">
            <span>전화번호</span>
            <input type="text" class="modaltitlebox" id="modalPhone">
        </div>
        <div class="modaltitle">
            <span>주소</span>
            <input type="text" class="modaltitlebox" id="modalAddress">
        </div>
        <div class="modaltitle">
            <span>로그인 비밀번호</span>
            <input type="password" class="modaltitlebox" id="modalPassword">
        </div>
        <div class="buttonset">
            <button class="submit-modal">저장</button>
            <button class="close-modal">닫기</button>
        </div>
    </div>
</div>
<!-- 비밀번호 확인 모달 -->
<div id="passwordCheckModal" class="modal-overlay">
    <div class="modal-content">
        <h2>비밀번호 확인</h2>
        <input type="password" id="checkPasswordInput" placeholder="현재 비밀번호 입력" class="modaltitlebox" />
        <div class="buttonset">
            <button class="submit-password">확인</button>
            <button class="close-password">취소</button>
        </div>
    </div>
</div>
</body>
</html>
<script>
    let currentUser = null;

    $(document).ready(function () {
        $.ajax({
            url: "/api/users/readUserBySession",
            method: "GET",
            success: function (res) {
                if (res.status === "ok") {
                    currentUser = res.result;

                    // 화면 바깥 정보 출력
                    $("#userName").text(currentUser.name);
                    $("#todayDate").text(getToday());
                    $("#todayWeekday").text(getWeekday());
                    $("#infoName").text(currentUser.name);
                    $("#infoPosition").text(currentUser.position);
                    $("#infoDepartment").text(currentUser.department);
                    $("#infoPhone").text(currentUser.phone);
                    if (currentUser.profileImage) {
                        $("#profileImage").attr("src", "/images/" + currentUser.profileImage);
                    }
                }
            }
        });

        // 개인정보 수정 버튼 → 비번 확인 모달
        $("#editUserBtn").on("click", function () {
            $("#checkPasswordInput").val("");
            $("#passwordCheckModal").fadeIn(200).css("display", "flex");
        });

        // 비밀번호 확인 취소
        $(".close-password").on("click", function () {
            $("#passwordCheckModal").fadeOut(200);
        });

        // 비밀번호 확인 제출
        $(".submit-password").on("click", function () {
            const pw = $("#checkPasswordInput").val();
            if (!pw) return alert("비밀번호를 입력하세요.");

            $.ajax({
                url: "/api/users/checkPassword",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ id: currentUser.id, password: pw }),
                success: function (res) {
                    if (res.status === "ok") {
                        $("#passwordCheckModal").fadeOut(200);
                        openEditModal(); // 진짜 수정 모달 열기
                    } else {
                        alert("비밀번호가 일치하지 않습니다.");
                    }
                },
                error: function () {
                    alert("서버 오류 발생");
                }
            });
        });

        // 수정 모달 열기
        function openEditModal() {
            $("#modalEmail").val(currentUser.email);
            $("#modalPhone").val(currentUser.phone);
            $("#modalAddress").val(currentUser.addr || "");
            $("#modalPassword").val("");

            $("#modalOverlay").fadeIn(200).css("display", "flex");
        }
    });

        // 저장 버튼 클릭
        $(".submit-modal").on("click", function () {
            const updated = {
                id: currentUser.id,
                email: $("#modalEmail").val(),
                phone: $("#modalPhone").val(),
                addr: $("#modalAddress").val(),
                password: $("#modalPassword").val()
            };

            $.ajax({
                url: "/api/users/updateUser",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(updated),
                success: function (res) {
                    if (res.status === "ok") {
                        alert("수정 완료!");
                        closeModal(); // 모달 닫기
                        location.reload();
                    } else {
                        alert("수정 실패: " + res.error);
                    }
                }
            });
        });

        // 닫기 버튼 클릭 시 모달 닫기
        $(".close-modal").on("click", function () {
            closeModal();
        });

        // 공통 모달 닫기 함수
        function closeModal() {
            $("#modalOverlay").fadeOut(200);
        }

        function getToday() {
            const now = new Date();
            return `${now.getFullYear()}년 ${String(now.getMonth() + 1).padStart(2, "0")}월 ${String(now.getDate()).padStart(2, "0")}일`;
        }
        function getWeekday() {
            return new Date().toLocaleDateString("ko-KR", { weekday: 'long' });
        }

    $(".approvalcontent").on("click", function () {
        const url = $(this).data("url");
        window.location.href = url;
    });
</script>

