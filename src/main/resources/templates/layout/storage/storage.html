<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drive Storage</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/storage.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<input type="hidden" id="selected-department-id">
<input type="hidden" id="selected-team-id">
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">공유문서함</div>
            <div class="mainnavbar">
                <div id="navlist2">문서함</div>
            </div>
        </div>
        <div class="section">
            <div class="leftarticle">
                <!--<div class="orgaddbox">
                    &lt;!&ndash;<button class="addbtn" id="addteambtn">폴더추가</button>&ndash;&gt;
                </div>-->
                <div class="orgchart">
                    <ul class="tree" id="tree-root"></ul>
                </div>
            </div>
            <div class="rightarticle">
                <div class="righttop">
                    <input type="text" id="fileSearch" placeholder="파일 검색...">
                    <button id="downloadSelected" class="whitebtn">선택 다운로드</button>
                    <button id="deleteSelected" class="whitebtn">선택 삭제</button>
                </div>
                <div class="rightmain">
                    <!-- 업로드 버튼 (초기에는 숨김) -->
                    <button id="open-upload-modal" class="btn btn-primary" style="display: none; margin-top: 20px;">파일
                        업로드
                    </button>

                    <!-- 업로드 모달 -->
                    <div id="upload-modal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <button id="close-upload-modal" class="modal-close">&times;</button>
                            <h2 class="modal-title">파일 업로드</h2>

                            <!-- 업로드 폼 -->
                            <form id="upload-form" class="upload-form">
                                <input type="text" id="file-name-display" class="form-input" placeholder="파일을 선택하세요"
                                       readonly>
                                <select id="file-category" class="form-select" required>
                                    <option value="" disabled selected>파일 분류 선택</option>
                                    <option value="영업">영업</option>
                                    <option value="인사">인사</option>
                                    <option value="재무">재무</option>
                                </select>
                                <button id="file-select-btn" type="button" class="whitebtn">파일 선택</button>
                                <button id="upload-btn" class="whitebtn">업로드</button>
                                <input type="file" id="file-input" class="file-input" style="display: none;">
                            </form>
                        </div>
                    </div>
                    <div class="list-container">

                    </div>
                </div>
            </div>
        </div>
        <!--&lt;!&ndash; 폴더 추가 모달 &ndash;&gt;
        <div class="modal-overlay" id="teammodal">
            <form class="modal-form" id="teammodal-form">
                <div class="modal-content">
                    <h2>폴더 추가</h2>
                    <div class="modalteamtitle">
                        <span>상위 폴더 선택</span>
                        <select id="parent-folder-select"></select>
                    </div>
                    <div class="modalteamtitle">
                        <span>폴더 이름</span>
                        <input class="modaltitle" id="teammodal-title" type="text" placeholder="폴더명을 입력해주세요"/>
                    </div>
                    <div class="buttonset">
                        <button type="submit" class="submit-modal">추가하기</button>
                        <button type="button" class="close-modal" id="teamclose">닫기</button>
                    </div>
                </div>
            </form>
        </div>-->
    </div>
</div>
<script>
    // 폴더 노드 렌더링 함수
    function renderFolderNode(folder, isOpen = false) {
        const $li = $("<li>");
        const $span = $("<span>").addClass("folder").attr("data-id", folder.id).text(`📁 ${folder.name}`);

        // 자식 폴더가 있다면 화살표 추가
        if (folder.hasChild) {
            $span.prepend('<i class="bi bi-chevron-right toggle-icon"></i> ');
        }

        // 폴더 삭제 버튼 추가
        const $deleteBtn = $('<i>').addClass('bi bi-x delete-folder').attr('data-id', folder.id);
        $span.append($deleteBtn);

        $li.append($span);

        // 폴더가 열려 있다면 자식 폴더 추가
        if (isOpen && folder.children?.length > 0) {
            const $ul = $("<ul>");
            folder.children.forEach(child => $ul.append(renderFolderNode(child)));
            $li.append($ul).addClass("open");
            $span.find(".toggle-icon").removeClass("bi-chevron-right").addClass("bi-chevron-down");
        }

        return $li;
    }


    function createFolderTree(id, activeId = null) {
        const folder = storageManager.folders[id];
        const $li = $("<li>");
        const $span = $("<span>").addClass("folder").attr("data-id", id);

        if (folder.children.length > 0) {
            $span.append('<i class="bi bi-chevron-right toggle-icon"></i> ');
        }
        $span.append(`📁 ${folder.name}`);
        const $deleteBtn = $('<i>').addClass('bi bi-x delete-folder').attr('data-id', id);
        $span.append($deleteBtn);
        $li.append($span);

        if (folder.children.length > 0) {
            const $ul = $("<ul>");
            folder.children.forEach(childId => $ul.append(createFolderTree(childId, activeId)));
            $li.append($ul);
        }

        if (id === activeId) {
            $li.addClass("open");
            $span.find(".toggle-icon").removeClass("bi-chevron-right").addClass("bi-chevron-down");
        }
        return $li;
    }

    // 폴더 트리 렌더링 함수 수정
    function renderFolderTree(data) {
        const $treeRoot = $("#tree-root").empty();
        data.forEach(dept => {
            const $deptLi = $("<li>");
            const $span = $(`<span class='folder dept' data-id='${dept.id}' data-type='department'>📁 ${dept.name}</span>`);

            // 자식 폴더가 있으면 화살표 추가
            if (dept.hasChild) {
                $span.prepend('<i class="bi bi-chevron-right toggle-icon"></i> ');
            }
            $deptLi.append($span);

            // 자식 폴더 렌더링
            if (dept.children && dept.children.length > 0) {
                const $ul = $("<ul>").hide();
                dept.children.forEach(team => {
                    // 자식 폴더 왼쪽에 `ㄴ` 모양 추가
                    const $childLi = $(`<li class="asddas"><span class='folder team' data-id='${team.id}' data-type='team'>📁 ${team.name}</span></li>`);
                    $childLi.prepend('<span class="sub-folder-icon">ㄴ</span>'); // `ㄴ` 기호 추가
                    $ul.append($childLi);
                });
                $deptLi.append($ul);
            }
            $treeRoot.append($deptLi);
        });
    }


    // 파일 리스트 렌더링 함수
    function renderFileList(files) {
        console.log("renderFileList 함수 호출, 파일 목록:", files);

        if (!Array.isArray(files)) {
            console.error("renderFileList: 전달된 값이 배열이 아님!", files);
            return;
        }

        const $fileListContainer = $(".rightmain .list-container");
        $fileListContainer.empty();

        let html = `
     <div class="listtop">
         <input type="checkbox" class="selectAll list-cell">
         <div class="list-cell">번호</div>
         <div class="list-cell listtitle">제목</div>
         <div class="list-cell">파일분류</div>
         <div class="list-cell">작성자</div>
         <div class="list-cell">작성일</div>
         <div class="list-cell">삭제</div>
     </div>
 `;

        if (!files.length) {
            html += `<div class='list-empty' style='width: 100%; text-align: center; padding: 20px;'>파일이 없습니다</div>`;
            console.log("파일 목록이 없습니다.");
        } else {
            files.forEach((file, index) => {
                console.log(`파일 ${index + 1}:`, file);

                html += `<div class="listcontent" data-id="${file.id}">
                 <input type="checkbox" class="childCheckbox list-cell">
                 <div class="list-cell">${index + 1}</div>
                 <div class="list-cell listtitle pointer" data-path="${file.path}" data-name="${file.name}">
                     ${file.name}
                 </div>
                 <div class="list-cell">${file.category || "-"}</div>
                 <div class="list-cell">${file.authorName || "-"}</div>
                 <div class="list-cell">${file.createdAt || "-"}</div>
                 <div class="list-cell"><i class="bi bi-trash3 filedelete"></i></div>
             </div>`;
            });
        }

        console.log("파일 목록 HTML 생성 완료:", html);
        $fileListContainer.html(html);
    }



    // 클릭 이벤트 위임 사용
    $(document).on("click", ".listtitle", function () {
        const path = $(this).data("path");
        const name = $(this).data("name");

        if (!path || !name) {
            console.warn("경로 또는 파일명이 없습니다.");
            return;
        }

        // 서버로 다운로드를 위한 URL 요청
        const url = `/api/dataroom/download?path=${encodeURIComponent(path)}&name=${encodeURIComponent(name)}`;
        window.location.href = url;  // 해당 URL로 리다이렉트하여 다운로드 시작
    });




    function saveOpenFolders() {
        const openFolders = [];
        $("#tree-root .open > .folder").each(function () {
            openFolders.push($(this).data("id"));
        });
        localStorage.setItem("openFolders", JSON.stringify(openFolders));
    }

    function loadFolderTree() {
        $.get("/api/dep/hierarchy", function (data) {
            renderFolderTree(data); // 데이터 렌더링
        });
    }

    $(document).ready(function () {
        const $listContainer = $(".list-container");
        const $modal = $("#upload-modal");
        const $openButton = $("#open-upload-modal");
        const $closeButton = $("#close-upload-modal");
        const $fileInput = $("#file-input");
        const $fileNameDisplay = $("#file-name-display");
        const $fileCategory = $("#file-category");
        const $uploadBtn = $("#upload-btn");
        if ($listContainer.length) {
            let html = `
            <div class="listtop">
                <input type="checkbox" class="selectAll list-cell">
                <div class="list-cell">번호</div>
                <div class="list-cell listtitle">제목</div>
                <div class="list-cell">파일분류</div>
                <div class="list-cell">작성자</div>
                <div class="list-cell">작성일</div>
                <div class="list-cell">삭제</div>
            </div>
            <div class="listmain">
                <div class="list-empty" style="text-align: center; padding: 20px;">파일이 없습니다.</div>
            </div>
        `;
            $listContainer.html(html); // 파일 리스트만 삽입
        }

        loadFolderTree();
        const $uploadFormContainer = $("#upload-form-container");


        let clickLocked = false;



        $(document).on("click", ".folder", function () {
            // 클릭된 폴더 요소
            const $span = $(this);
            const folderId = $span.data("id");
            const isDepartment = $span.data("type") === "department";
            const queryParam = isDepartment ? `departmentId=${folderId}` : `teamId=${folderId}`;


            // 폴더 타입 로그
            console.log(`폴더 클릭됨, 폴더 ID: ${folderId}, 폴더 타입: ${isDepartment ? "부서" : "팀"}`);
            console.log(`쿼리 파라미터: ${queryParam}`);

            // 선택된 폴더 처리
            $(".folder").removeClass("selected");  // 다른 폴더들에서 selected 제거
            $span.addClass("selected");  // 클릭한 폴더에 selected 추가

            // 선택된 폴더의 ID 확인
            const selectedFolderId = $(".folder.selected").data("id");
            console.log(`선택된 폴더 ID: ${selectedFolderId}`);  // 이 값이 undefined가 아니라 정상적으로 나와야 합니다.


            $(".folder").find(".checkmark").remove(); // 기존 체크 표시 제거
            $span.append('<span class="checkmark">✅</span>'); // 현재 선택된 폴더에 체크 표시 추가



            // 폴더 열기/닫기 처리
            const $li = $span.closest("li");
            const $icon = $span.find(".toggle-icon");
            const isOpen = $li.hasClass("open");

            if (isOpen) {
                $li.removeClass("open");
                $li.children("ul").slideUp(200);
                $icon.removeClass("bi-chevron-down").addClass("bi-chevron-right");
                console.log(`폴더 ${folderId} 닫힘`);
            } else {
                const $existingUl = $li.children("ul");
                if ($existingUl.length > 0) {
                    $li.addClass("open");
                    $existingUl.slideDown(200);
                    $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                    console.log(`폴더 ${folderId} 이미 열려있는 폴더 처리됨`);
                } else {
                    // 하위 폴더 로딩
                    $.get(`/api/dataroom/subfolders/json/${folderId}`).done(function (subfolders) {
                        console.log("하위 폴더 데이터:", subfolders);
                        const $ul = $("<ul>");
                        subfolders.forEach(f => {
                            const $childLi = $("<li>");
                            const $childSpan = $("<span>")
                                .addClass("folder")
                                .attr("data-id", f.id)
                                .attr("data-type", "team") // 하위 폴더는 팀으로 처리
                                .html(`└📁 ${f.name}`);
                            $childLi.append($childSpan);
                            $ul.append($childLi);
                        });
                        $li.append($ul).addClass("open");
                        $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                        console.log(`하위 폴더 ${folderId} 로딩 완료`);
                    }).fail(function (error) {
                        console.error("폴더 데이터 로딩 실패:", error);
                    });
                }
            }

            // 파일 목록 요청
            $.get(`/api/dataroom/files?${queryParam}`, function (files) {
                console.log("파일 목록 요청 응답:", files);
                if (!Array.isArray(files)) {
                    console.warn("renderFileList: 전달된 값이 배열이 아님!", files);
                    return;
                }
                renderFileList(files);  // 파일 목록 렌더링
            }).fail(function (error) {
                console.error("파일 목록 요청 실패:", error);
            });

            $openButton.show(); // 업로드 버튼 표시
        });







        $(document).on("dblclick", ".folder", function (e) {
            e.stopPropagation();
            const folderId = $(this).data("id");
            const currentName = storageManager.folders[folderId].name;
            const $span = $(this);
            const $input = $("<input>").val(currentName).css({width: "100px"}).on("blur keypress", function (e) {
                if (e.type === "blur" || e.key === "Enter") {
                    const newName = $(this).val().trim();
                    if (newName && newName !== currentName) {
                        storageManager.folders[folderId].name = newName;
                        renderFolderTree(folderId); // 열린 상태 유지
                    } else {
                        $span.html(`📁 ${currentName}`);
                    }
                }
            });
            $span.html($input);
            $input.focus();
        });

        /*$("#addteambtn").on("click", function () {
            const $select = $("#parent-folder-select").empty();

            function addOptions(id, prefix = "") {
                const folder = storageManager.folders[id];
                $select.append(`<option value="${id}">${prefix}${folder.name}</option>`);
                folder.children.forEach(childId => addOptions(childId, prefix + "└ "));
            }

            addOptions(1);
            $("#teammodal").css("display", "flex");
        });*/

        $("#teamclose").on("click", () => $("#teammodal").css("display", "none")); // 중복 제거

        $("#teammodal-form").on("submit", function (e) {
            e.preventDefault();
            const name = $("#teammodal-title").val().trim();
            const parentId = parseInt($("#parent-folder-select").val());
            if (!name || isNaN(parentId)) return;
            const newId = storageManager.addFolder(name, parentId);
            $("#teammodal").css("display", "none");
            $("#teammodal-title").val("");
            renderFolderTree(newId);
        });

        $(document).on("click", ".delete-folder", function (e) {
            e.stopPropagation();
            alert("구현필요");
            /*const folderId = $(this).data("id");
            const folder = storageManager.folders[folderId];
            const parentId = Object.entries(storageManager.folders).find(([_, v]) => v.children.includes(folderId))?.[0] || 1;

            if ((folder.children.length > 0) || (storageManager.files[folderId]?.length > 0)) {
                alert("하위 폴더나 파일이 있어 삭제할 수 없습니다.");
                return;
            }

            if (confirm("정말 이 폴더를 삭제하시겠습니까?")) {
                storageManager.deleteFolder(folderId);
                renderFolderTree(parentId);  // 폴더 삭제 후 UI 갱신
                $(".rightmain").empty();     // 파일 목록 초기화
            }*/
        });


        $(document).on("click", ".filedelete", function () {
            const $listItem = $(this).closest(".listcontent");
            const fileId = $listItem.data("id");

            if (!confirm("정말 이 파일을 삭제하시겠습니까?")) return;

            $.ajax({
                url: `/api/dataroom/deleteFiles`,
                type: 'POST',
                data: { id: fileId },
                success: function (res) {
                    if (res.status === "ok") {
                        alert("파일이 삭제되었습니다.");
                        $listItem.remove(); // UI에서 삭제
                    } else {
                        alert("삭제 실패: " + res.error);
                    }
                },
                error: function (xhr) {
                    alert("삭제 중 오류 발생: " + xhr.responseText);
                }
            });
        });

        $("#deleteSelected").on("click", function () {
            const selectedIds = $(".childCheckbox:checked").map(function () {
                return $(this).closest(".listcontent").data("id");
            }).get();

            if (selectedIds.length === 0) {
                alert("삭제할 파일을 선택하세요.");
                return;
            }

            if (!confirm("선택한 파일들을 정말 삭제하시겠습니까?")) return;

            $.ajax({
                url: '/api/dataroom/deleteMultiple',
                type: 'POST',
                traditional: true,
                data: { ids: selectedIds },
                success: function (res) {
                    if (res.status === "ok") {
                        alert("파일이 삭제되었습니다.");
                        selectedIds.forEach(id => {
                            $(`.listcontent[data-id="${id}"]`).remove();
                        });
                    } else {
                        alert("삭제 실패: " + res.error);
                    }
                },
                error: function (xhr) {
                    alert("삭제 중 오류 발생: " + xhr.responseText);
                }
            });
        });


        // 모달 열기
        $openButton.on("click", function () {
            $modal.css("display", "flex"); // 모달을 flex로 표시
        });

        // 모달 닫기
        $closeButton.on("click", function () {
            $modal.hide(); // 모달 숨김
        });

        // 모달 외부 클릭 시 닫기

        $(window).on("click", function (e) {
            if ($(e.target).is($modal)) {
                $modal.hide();
            }
        });

        // 파일 선택 버튼 클릭
        $("#file-select-btn").on("click", function () {
            $fileInput.click();
        });

        // 파일 선택 시 파일 이름 표시
        $fileInput.on("change", function () {
            const fileName = $fileInput[0].files[0]?.name || "파일을 선택하세요";
            $fileNameDisplay.val(fileName);
        });


        // 업로드 버튼 클릭
        // 업로드 버튼 클릭 시
        $("#upload-btn").on("click", function () {
            const file = $("#file-input")[0].files[0];
            const category = $("#file-category").val();

            console.log("업로드 시작");

            if (!file) {
                alert("파일을 선택해주세요.");
                console.warn("파일이 선택되지 않았습니다.");
                return;
            }

            if (!category) {
                alert("파일 분류를 선택해주세요.");
                console.warn("파일 분류가 선택되지 않았습니다.");
                return;
            }

            const folderId = $(".folder.selected").data("id");
            const isDepartment = $(".folder.selected").data("type") === "department";

            console.log("선택된 폴더 ID:", folderId);
            console.log("부서 여부:", isDepartment);

            const formData = new FormData();
            formData.append("upload", file);
            formData.append("category", category);
            const title = file.name;
            formData.append("title", title);
            if (isDepartment) {
                formData.append("departmentId", folderId);
            } else {
                formData.append("teamId", folderId);
            }

            console.log("폴더 DOM 정보:", $(".folder.selected"));

            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }


            $.ajax({
                url: "/api/dataroom/upload",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function (xhr) {
                    console.log("AJAX 요청 시작...");
                },
                success: function (response) {
                    console.log("업로드 성공 응답:", response);
                    alert(response.message || "파일 업로드 성공!");

                    // 파일 목록 갱신
                    const queryParam = $("#selected-department-id").val() ? `departmentId=${$("#selected-department-id").val()}` : `teamId=${$("#selected-team-id").val()}`;
                    console.log("파일 목록 요청 URL:", `/api/dataroom/files?${queryParam}`);

                    $.get(`/api/dataroom/files?${queryParam}`, function (files) {
                        console.log("파일 목록 응답:", files);

                        if (!Array.isArray(files)) {
                            console.warn("renderFileList: 전달된 값이 배열이 아님!", files);
                            return;
                        }

                        console.log("파일 목록 렌더링 중...");
                        renderFileList(files);
                    }).fail(function (error) {
                        console.error("파일 목록 요청 실패:", error);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("업로드 실패:", status, error);
                    alert("파일 업로드 실패!");
                    console.log("상태 코드:", xhr.status);  // 상태 코드 출력
                    console.log("응답 본문:", xhr.responseText);  // 응답 본문 출력
                },
                statusCode: {
                    404: function () {
                        console.error("404 오류: 해당 URL을 찾을 수 없습니다.");
                    },
                    500: function () {
                        console.error("500 오류: 서버 내부 오류 발생");
                    }
                }
            });
        });








        $("#downloadSelected").on("click", function () {
            const selectedIds = $(".childCheckbox:checked").map(function () {
                return $(this).closest(".listcontent").data("id");
            }).get();

            if (selectedIds.length === 0) {
                alert("다운로드할 파일을 선택하세요.");
                return;
            }

            // 여러 파일 다운로드 - 서버에서 zip 파일 생성 후 다운로드 링크 제공
            $.ajax({
                url: '/api/dataroom/downloadMultiple',
                type: 'POST',
                traditional: true,
                data: { ids: selectedIds },
                success: function (res) {
                    if (res.status === "ok" && res.downloadUrl) {
                        window.location.href = res.downloadUrl; // zip 파일 다운로드 링크로 리디렉션
                    } else {
                        alert("다운로드 실패: " + res.error);
                    }
                },
                error: function (err) {
                    alert("서버 오류 발생: " + err.responseText); // 에러 메시지 출력
                }
            });
        });



        $("#fileSearch").on("input", function () {
            const folderId = $(".folder.selected").data("id");
            renderFileList(folderId, $(this).val());
        });

        $(document).on("change", ".selectAll", function () {
            $(".childCheckbox").prop("checked", $(this).is(":checked"));
        });


        // "파일 업로드" 버튼 클릭 시 업로드 폼 토글
        $("#toggleUploadForm").on("click", function () {
            $uploadFormContainer.toggle();
        });

        // 파일 선택 버튼 클릭 시 파일 선택 창 열기
        $("#fileSelectBtn").on("click", function () {
            $fileInput.click();
        });

        // 파일 선택 시 파일 이름 표시
        $("#fileInput").on("change", function () {
            const fileName = $fileInput[0].files[0]?.name || "파일을 선택하세요";
            $fileNameDisplay.val(fileName);
        });
    });

</script>
</body>
</html>