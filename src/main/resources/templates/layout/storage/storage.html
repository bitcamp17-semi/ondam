<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drive Storage</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/storage.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<input type="hidden" id="selected-department-id">
<input type="hidden" id="selected-team-id">
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">ê³µìœ ë¬¸ì„œí•¨</div>
            <div class="navbar">
                <div id="navlist2">ë¬¸ì„œí•¨</div>
            </div>
        </div>
        <div class="section">
            <div class="leftarticle">
                <div class="orgaddbox">
                    <button class="addbtn" id="addteambtn">í´ë”ì¶”ê°€</button>
                </div>
                <div class="orgchart">
                    <ul class="tree" id="tree-root"></ul>
                </div>
            </div>
            <div class="rightarticle">
                <div class="righttop">
                    <input type="text" id="fileSearch" placeholder="íŒŒì¼ ê²€ìƒ‰...">
                    <button id="downloadSelected" class="whitebtn">ì„ íƒ ë‹¤ìš´ë¡œë“œ</button>
                    <button id="deleteSelected" class="whitebtn">ì„ íƒ ì‚­ì œ</button>
                </div>
                <div class="rightmain">
                    <!-- ì—…ë¡œë“œ ë²„íŠ¼ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
                    <button id="open-upload-modal" class="btn btn-primary" style="display: none; margin-top: 20px;">íŒŒì¼
                        ì—…ë¡œë“œ
                    </button>

                    <!-- ì—…ë¡œë“œ ëª¨ë‹¬ -->
                    <div id="upload-modal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <button id="close-upload-modal" class="modal-close">&times;</button>
                            <h2 class="modal-title">íŒŒì¼ ì—…ë¡œë“œ</h2>

                            <!-- ì—…ë¡œë“œ í¼ -->
                            <form id="upload-form" class="upload-form">
                                <input type="text" id="file-name-display" class="form-input" placeholder="íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”"
                                       readonly>
                                <select id="file-category" class="form-select" required>
                                    <option value="" disabled selected>íŒŒì¼ ë¶„ë¥˜ ì„ íƒ</option>
                                    <option value="ì˜ì—…">ì˜ì—…</option>
                                    <option value="ì¸ì‚¬">ì¸ì‚¬</option>
                                    <option value="ì¬ë¬´">ì¬ë¬´</option>
                                </select>
                                <button id="file-select-btn" class="btn btn-secondary">íŒŒì¼ ì„ íƒ</button>
                                <button id="upload-btn" class="btn btn-primary">ì—…ë¡œë“œ</button>
                                <input type="file" id="file-input" class="file-input" style="display: none;">
                            </form>
                        </div>
                    </div>
                    <div class="list-container">

                    </div>
                </div>
            </div>
        </div>
        <!-- í´ë” ì¶”ê°€ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="teammodal">
            <form class="modal-form" id="teammodal-form">
                <div class="modal-content">
                    <h2>í´ë” ì¶”ê°€</h2>
                    <div class="modalteamtitle">
                        <span>ìƒìœ„ í´ë” ì„ íƒ</span>
                        <select id="parent-folder-select"></select>
                    </div>
                    <div class="modalteamtitle">
                        <span>í´ë” ì´ë¦„</span>
                        <input class="modaltitle" id="teammodal-title" type="text" placeholder="í´ë”ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
                    </div>
                    <div class="buttonset">
                        <button type="submit" class="submit-modal">ì¶”ê°€í•˜ê¸°</button>
                        <button type="button" class="close-modal" id="teamclose">ë‹«ê¸°</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // í´ë” ë…¸ë“œ ë Œë”ë§ í•¨ìˆ˜
    function renderFolderNode(folder, isOpen = false) {
        const $li = $("<li>");
        const $span = $("<span>").addClass("folder").attr("data-id", folder.id).text(`ğŸ“ ${folder.name}`);

        // ìì‹ í´ë”ê°€ ìˆë‹¤ë©´ í™”ì‚´í‘œ ì¶”ê°€
        if (folder.hasChild) {
            $span.prepend('<i class="bi bi-chevron-right toggle-icon"></i> ');
        }

        // í´ë” ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        const $deleteBtn = $('<i>').addClass('bi bi-x delete-folder').attr('data-id', folder.id);
        $span.append($deleteBtn);

        $li.append($span);

        // í´ë”ê°€ ì—´ë ¤ ìˆë‹¤ë©´ ìì‹ í´ë” ì¶”ê°€
        if (isOpen && folder.children?.length > 0) {
            const $ul = $("<ul>");
            folder.children.forEach(child => $ul.append(renderFolderNode(child)));
            $li.append($ul).addClass("open");
            $span.find(".toggle-icon").removeClass("bi-chevron-right").addClass("bi-chevron-down");
        }

        return $li;
    }


    function createFolderTree(id, activeId = null) {
        const folder = storageManager.folders[id];
        const $li = $("<li>");
        const $span = $("<span>").addClass("folder").attr("data-id", id);

        if (folder.children.length > 0) {
            $span.append('<i class="bi bi-chevron-right toggle-icon"></i> ');
        }
        $span.append(`ğŸ“ ${folder.name}`);
        const $deleteBtn = $('<i>').addClass('bi bi-x delete-folder').attr('data-id', id);
        $span.append($deleteBtn);
        $li.append($span);

        if (folder.children.length > 0) {
            const $ul = $("<ul>");
            folder.children.forEach(childId => $ul.append(createFolderTree(childId, activeId)));
            $li.append($ul);
        }

        if (id === activeId) {
            $li.addClass("open");
            $span.find(".toggle-icon").removeClass("bi-chevron-right").addClass("bi-chevron-down");
        }
        return $li;
    }

    // í´ë” íŠ¸ë¦¬ ë Œë”ë§ í•¨ìˆ˜ ìˆ˜ì •
    function renderFolderTree(data) {
        const $treeRoot = $("#tree-root").empty();
        data.forEach(dept => {
            const $deptLi = $("<li>");
            const $span = $(`<span class='folder dept' data-id='${dept.id}'>ğŸ“ ${dept.name}</span>`);

            // ìì‹ í´ë”ê°€ ìˆìœ¼ë©´ í™”ì‚´í‘œ ì¶”ê°€
            if (dept.hasChild) {
                $span.prepend('<i class="bi bi-chevron-right toggle-icon"></i> ');
            }
            $deptLi.append($span);

            // ìì‹ í´ë” ë Œë”ë§
            if (dept.children && dept.children.length > 0) {
                const $ul = $("<ul>").hide();
                dept.children.forEach(team => {
                    // ìì‹ í´ë” ì™¼ìª½ì— `ã„´` ëª¨ì–‘ ì¶”ê°€
                    const $childLi = $(`<li class="asddas"><span class='folder team' data-id='${team.id}'>ğŸ“ ${team.name}</span></li>`);
                    $childLi.prepend('<span class="sub-folder-icon">ã„´</span>'); // `ã„´` ê¸°í˜¸ ì¶”ê°€
                    $ul.append($childLi);
                });
                $deptLi.append($ul);
            }
            $treeRoot.append($deptLi);
        });
    }


    // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
    function renderFileList(files) {
        console.log("renderFileList í•¨ìˆ˜ í˜¸ì¶œ, íŒŒì¼ ëª©ë¡:", files);

        if (!Array.isArray(files)) {
            console.error("renderFileList: ì „ë‹¬ëœ ê°’ì´ ë°°ì—´ì´ ì•„ë‹˜!", files);
            return;
        }

        const $fileListContainer = $(".rightmain .list-container");
        $fileListContainer.empty();

        let html = `
     <div class="listtop">
         <input type="checkbox" class="selectAll list-cell">
         <div class="list-cell">ë²ˆí˜¸</div>
         <div class="list-cell listtitle">ì œëª©</div>
         <div class="list-cell">íŒŒì¼ë¶„ë¥˜</div>
         <div class="list-cell">ì‘ì„±ì</div>
         <div class="list-cell">ì‘ì„±ì¼</div>
         <div class="list-cell">ì‚­ì œ</div>
     </div>
 `;

        if (!files.length) {
            html += `<div class='list-empty' style='width: 100%; text-align: center; padding: 20px;'>íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
            console.log("íŒŒì¼ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            files.forEach((file, index) => {
                console.log(`íŒŒì¼ ${index + 1}:`, file);

                html += `<div class="listcontent" data-id="${file.id}">
                 <input type="checkbox" class="childCheckbox list-cell">
                 <div class="list-cell">${index + 1}</div>
                 <div class="list-cell listtitle pointer" data-path="${file.path}" data-name="${file.name}">
                     ${file.name}
                 </div>
                 <div class="list-cell">${file.category || "-"}</div>
                 <div class="list-cell">${file.authorName || "-"}</div>
                 <div class="list-cell">${file.createdAt || "-"}</div>
                 <div class="list-cell"><i class="bi bi-trash3 filedelete"></i></div>
             </div>`;
            });
        }

        console.log("íŒŒì¼ ëª©ë¡ HTML ìƒì„± ì™„ë£Œ:", html);
        $fileListContainer.html(html);
    }



    // í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
    $(document).on("click", ".listtitle", function () {
        const path = $(this).data("path");
        const name = $(this).data("name");

        if (!path || !name) {
            console.warn("ê²½ë¡œ ë˜ëŠ” íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // ì„œë²„ë¡œ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ URL ìš”ì²­
        const url = `/api/dataroom/download?path=${encodeURIComponent(path)}&name=${encodeURIComponent(name)}`;
        window.location.href = url;  // í•´ë‹¹ URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì‹œì‘
    });




    function saveOpenFolders() {
        const openFolders = [];
        $("#tree-root .open > .folder").each(function () {
            openFolders.push($(this).data("id"));
        });
        localStorage.setItem("openFolders", JSON.stringify(openFolders));
    }

    function loadFolderTree() {
        $.get("/api/dep/hierarchy", function (data) {
            renderFolderTree(data); // ë°ì´í„° ë Œë”ë§
        });
    }

    $(document).ready(function () {
        const $listContainer = $(".list-container");
        const $modal = $("#upload-modal");
        const $openButton = $("#open-upload-modal");
        const $closeButton = $("#close-upload-modal");
        const $fileInput = $("#file-input");
        const $fileNameDisplay = $("#file-name-display");
        const $fileCategory = $("#file-category");
        const $uploadBtn = $("#upload-btn");
        if ($listContainer.length) {
            let html = `
            <div class="listtop">
                <input type="checkbox" class="selectAll list-cell">
                <div class="list-cell">ë²ˆí˜¸</div>
                <div class="list-cell listtitle">ì œëª©</div>
                <div class="list-cell">íŒŒì¼ë¶„ë¥˜</div>
                <div class="list-cell">ì‘ì„±ì</div>
                <div class="list-cell">ì‘ì„±ì¼</div>
                <div class="list-cell">ì‚­ì œ</div>
            </div>
            <div class="listmain">
                <div class="list-empty" style="text-align: center; padding: 20px;">íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        `;
            $listContainer.html(html); // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë§Œ ì‚½ì…
        }

        loadFolderTree();
        const $uploadFormContainer = $("#upload-form-container");


        let clickLocked = false;


        // ë¶€ì„œ í´ë” í´ë¦­ ì´ë²¤íŠ¸
        $(document).on("click", ".folder.dept", function () {
            const $li = $(this).closest("li");
            const $ul = $li.children("ul");
            const $icon = $(this).find(".toggle-icon");

            const folderId = $(this).data("id");
            console.log(`í´ë” ${folderId} í´ë¦­ë¨ (ë¶€ì„œ)`); // ë””ë²„ê¹…ìš© ë¡œê·¸

            $openButton.show(); // ì—…ë¡œë“œ ë²„íŠ¼ í‘œì‹œ

            if ($ul.length > 0) {
                if ($ul.is(":visible")) {
                    $ul.slideUp();
                    $icon.removeClass("bi-chevron-down").addClass("bi-chevron-right");
                    console.log(`í´ë” ${folderId} ìˆ¨ê¹€ ì²˜ë¦¬ë¨`);
                } else {
                    $ul.slideDown();
                    $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                    console.log(`í´ë” ${folderId} ì—´ë¦¼ ì²˜ë¦¬ë¨`);
                }
            }
        });
        /*$(document).on("click", ".listtitle", function () {
            const path = $(this).data("path");
            const name = $(this).data("name");

            if (!path || !name) {
                console.warn("ê²½ë¡œ ë˜ëŠ” íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const url = `/api/dataroom/download?path=${encodeURIComponent(path)}&name=${encodeURIComponent(name)}`;
            window.location.href = url;
        });*/



        // íŒ€ í´ë” í´ë¦­ ì´ë²¤íŠ¸
        $(document).on("click", ".folder.team", function () {
            const teamId = $(this).data("id");
            $(".folder").removeClass("selected");
            $(this).addClass("selected");
            $("#upload-folder-id").val(teamId);

            console.log(`í´ë” ${teamId} í´ë¦­ë¨ (íŒ€)`); // ë””ë²„ê¹…ìš© ë¡œê·¸

            $.get(`/api/dataroom/files?teamId=${teamId}`, function (files) {
                console.log("íŒŒì¼ ëª©ë¡:", files); // ì„œë²„ë¡œë¶€í„° ë°˜í™˜ëœ íŒŒì¼ ëª©ë¡
                renderFileList(files);  // íŒŒì¼ ëª©ë¡ ë Œë”ë§
            }).fail(function (error) {
                console.error("íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨:", error); // ì˜¤ë¥˜ ë¡œê·¸
            });
        });

        // í´ë” í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì • (ë¶€ì„œ/íŒ€ êµ¬ë¶„)
        $(document).on("click", ".folder", function () {
            $(".folder").removeClass("active");
            $(this).addClass("active");

            const folderId = $(this).data("id");
            const isDepartment = $(this).data("type") === "department";
            const queryParam = isDepartment ? `departmentId=${folderId}` : `teamId=${folderId}`;
            console.log(`í´ë” í´ë¦­ë¨, í´ë” ID: ${folderId}, í´ë” íƒ€ì…: ${isDepartment ? "ë¶€ì„œ" : "íŒ€"}`);  // ë””ë²„ê¹…ìš© ë¡œê·¸
            console.log(`ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°: ${queryParam}`);  // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í™•ì¸

            // í´ë” ì—´ê¸°/ë‹«ê¸° ì²˜ë¦¬
            const $span = $(this);
            const $li = $span.closest("li");
            const $icon = $span.find(".toggle-icon");
            const isOpen = $li.hasClass("open");

            if (isOpen) {
                $li.removeClass("open");
                $li.children("ul").slideUp(200);
                $icon.removeClass("bi-chevron-down").addClass("bi-chevron-right");
                console.log(`í´ë” ${folderId} ë‹«í˜`);
            } else {
                const $existingUl = $li.children("ul");
                if ($existingUl.length > 0) {
                    $li.addClass("open");
                    $existingUl.slideDown(200);
                    $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                    console.log(`í´ë” ${folderId} ì´ë¯¸ ì—´ë ¤ìˆëŠ” í´ë” ì²˜ë¦¬ë¨`);
                } else {
                    $.get(`/api/dataroom/subfolders/json/${folderId}`).done(function (subfolders) {
                        console.log("í•˜ìœ„ í´ë” ë°ì´í„°:", subfolders);  // í•˜ìœ„ í´ë” ë¡œë”© í™•ì¸
                        const $ul = $("<ul>");
                        subfolders.forEach(f => {
                            const $childLi = $("<li>");
                            const $childSpan = $("<span>")
                                .addClass("folder team")
                                .attr("data-id", f.id)
                                .html(`â””ğŸ“ ${f.name}`);
                            $childLi.append($childSpan);
                            $ul.append($childLi);
                        });
                        $li.append($ul).addClass("open");
                        $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                        console.log(`í•˜ìœ„ í´ë” ${folderId} ë¡œë”© ì™„ë£Œ`);
                    }).fail(function (error) {
                        console.error("í´ë” ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);  // ì˜¤ë¥˜ ë¡œê·¸
                    });
                }
            }

            // íŒŒì¼ ëª©ë¡ ìš”ì²­
            $.get(`/api/dataroom/files?${queryParam}`, function (files) {
                console.log("íŒŒì¼ ëª©ë¡ ìš”ì²­ ì‘ë‹µ:", files);  // ì„œë²„ ì‘ë‹µ í™•ì¸
                if (!Array.isArray(files)) {
                    console.warn("renderFileList: ì „ë‹¬ëœ ê°’ì´ ë°°ì—´ì´ ì•„ë‹˜!", files);
                    return;
                }
                renderFileList(files);  // íŒŒì¼ ëª©ë¡ ë Œë”ë§
            }).fail(function (error) {
                console.error("íŒŒì¼ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", error);  // ì˜¤ë¥˜ ë¡œê·¸
            });

            $openButton.show(); // ì—…ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
        });







        $(document).on("dblclick", ".folder", function (e) {
            e.stopPropagation();
            const folderId = $(this).data("id");
            const currentName = storageManager.folders[folderId].name;
            const $span = $(this);
            const $input = $("<input>").val(currentName).css({width: "100px"}).on("blur keypress", function (e) {
                if (e.type === "blur" || e.key === "Enter") {
                    const newName = $(this).val().trim();
                    if (newName && newName !== currentName) {
                        storageManager.folders[folderId].name = newName;
                        renderFolderTree(folderId); // ì—´ë¦° ìƒíƒœ ìœ ì§€
                    } else {
                        $span.html(`ğŸ“ ${currentName}`);
                    }
                }
            });
            $span.html($input);
            $input.focus();
        });

        $("#addteambtn").on("click", function () {
            const $select = $("#parent-folder-select").empty();

            function addOptions(id, prefix = "") {
                const folder = storageManager.folders[id];
                $select.append(`<option value="${id}">${prefix}${folder.name}</option>`);
                folder.children.forEach(childId => addOptions(childId, prefix + "â”” "));
            }

            addOptions(1);
            $("#teammodal").css("display", "flex");
        });

        $("#teamclose").on("click", () => $("#teammodal").css("display", "none")); // ì¤‘ë³µ ì œê±°

        $("#teammodal-form").on("submit", function (e) {
            e.preventDefault();
            const name = $("#teammodal-title").val().trim();
            const parentId = parseInt($("#parent-folder-select").val());
            if (!name || isNaN(parentId)) return;
            const newId = storageManager.addFolder(name, parentId);
            $("#teammodal").css("display", "none");
            $("#teammodal-title").val("");
            renderFolderTree(newId);
        });

        $(document).on("click", ".delete-folder", function (e) {
            e.stopPropagation();
            alert("êµ¬í˜„í•„ìš”");
            /*const folderId = $(this).data("id");
            const folder = storageManager.folders[folderId];
            const parentId = Object.entries(storageManager.folders).find(([_, v]) => v.children.includes(folderId))?.[0] || 1;

            if ((folder.children.length > 0) || (storageManager.files[folderId]?.length > 0)) {
                alert("í•˜ìœ„ í´ë”ë‚˜ íŒŒì¼ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (confirm("ì •ë§ ì´ í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                storageManager.deleteFolder(folderId);
                renderFolderTree(parentId);  // í´ë” ì‚­ì œ í›„ UI ê°±ì‹ 
                $(".rightmain").empty();     // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
            }*/
        });


        $(document).on("click", ".filedelete", function () {
            const $listItem = $(this).closest(".listcontent");
            const fileId = $listItem.data("id");

            if (!confirm("ì •ë§ ì´ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            $.ajax({
                url: `api/dataroom/deleteFiles`,
                type: 'POST',
                data: { id: fileId },
                success: function (res) {
                    if (res.status === "ok") {
                        alert("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        $listItem.remove(); // UIì—ì„œ ì œê±°
                    } else {
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + res.error);
                    }
                },
                error: function (xhr) {
                    alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + xhr.responseText);
                }
            });
        });

        $("#deleteSelected").on("click", function () {
            if (!confirm("ì„ íƒí•œ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const folderId = $(".folder.selected").data("id");
            const indexes = $(".childCheckbox:checked").map((_, el) => parseInt($(el).closest(".listcontent").attr("data-index"))).get().sort((a, b) => b - a);
            if (!indexes.length) {
                alert("ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            indexes.forEach(i => storageManager.files[folderId].splice(i, 1));
            renderFileList(folderId);
        });

        // ëª¨ë‹¬ ì—´ê¸°
        $openButton.on("click", function () {
            $modal.css("display", "flex"); // ëª¨ë‹¬ì„ flexë¡œ í‘œì‹œ
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        $closeButton.on("click", function () {
            $modal.hide(); // ëª¨ë‹¬ ìˆ¨ê¹€
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°

        $(window).on("click", function (e) {
            if ($(e.target).is($modal)) {
                $modal.hide();
            }
        });

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­
        $("#file-select-btn").on("click", function () {
            $fileInput.click();
        });

        // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ í‘œì‹œ
        $fileInput.on("change", function () {
            const fileName = $fileInput[0].files[0]?.name || "íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”";
            $fileNameDisplay.val(fileName);
        });


        // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­
        // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ
        $("#upload-btn").on("click", function () {
            const file = $("#file-input")[0].files[0];
            const category = $("#file-category").val();

            console.log("ì—…ë¡œë“œ ì‹œì‘");

            if (!file) {
                alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                console.warn("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            if (!category) {
                alert("íŒŒì¼ ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                console.warn("íŒŒì¼ ë¶„ë¥˜ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const folderId = $(".folder.selected").data("id");
            const isDepartment = $(".folder.selected").data("type") === "department";

            console.log("ì„ íƒëœ í´ë” ID:", folderId);
            console.log("ë¶€ì„œ ì—¬ë¶€:", isDepartment);

            const formData = new FormData();
            formData.append("upload", file);
            formData.append("category", category);
            const title = file.name;
            formData.append("title", title);
            if (isDepartment) {
                formData.append("departmentId", folderId);
            } else {
                formData.append("teamId", folderId);
            }

            // **ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€**
            console.log("ì—…ë¡œë“œ í¼ ë°ì´í„°:", formData);

            $.ajax({
                url: "/api/dataroom/upload",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function (xhr) {
                    console.log("AJAX ìš”ì²­ ì‹œì‘...");
                },
                success: function (response) {
                    console.log("ì—…ë¡œë“œ ì„±ê³µ ì‘ë‹µ:", response);
                    alert(response.message || "íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ!");

                    // íŒŒì¼ ëª©ë¡ ê°±ì‹ 
                    const queryParam = $("#selected-department-id").val() ? `departmentId=${$("#selected-department-id").val()}` : `teamId=${$("#selected-team-id").val()}`;
                    console.log("íŒŒì¼ ëª©ë¡ ìš”ì²­ URL:", `/api/dataroom/files?${queryParam}`);

                    $.get(`/api/dataroom/files?${queryParam}`, function (files) {
                        console.log("íŒŒì¼ ëª©ë¡ ì‘ë‹µ:", files);

                        if (!Array.isArray(files)) {
                            console.warn("renderFileList: ì „ë‹¬ëœ ê°’ì´ ë°°ì—´ì´ ì•„ë‹˜!", files);
                            return;
                        }

                        console.log("íŒŒì¼ ëª©ë¡ ë Œë”ë§ ì¤‘...");
                        renderFileList(files);
                    }).fail(function (error) {
                        console.error("íŒŒì¼ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨:", error);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", status, error);
                    alert("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨!");
                    console.log("ìƒíƒœ ì½”ë“œ:", xhr.status);  // ìƒíƒœ ì½”ë“œ ì¶œë ¥
                    console.log("ì‘ë‹µ ë³¸ë¬¸:", xhr.responseText);  // ì‘ë‹µ ë³¸ë¬¸ ì¶œë ¥
                },
                statusCode: {
                    404: function () {
                        console.error("404 ì˜¤ë¥˜: í•´ë‹¹ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    },
                    500: function () {
                        console.error("500 ì˜¤ë¥˜: ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ");
                    }
                }
            });
        });








        $("#downloadSelected").on("click", function () {
            const folderId = $(".folder.selected").data("id");
            const selectedFiles = $(".childCheckbox:checked").map((_, el) => storageManager.files[folderId][parseInt($(el).closest(".listcontent").attr("data-index"))].title).get();
            if (!selectedFiles.length) {
                alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            console.log("ë‹¤ìš´ë¡œë“œ ìš”ì²­:", selectedFiles);
            alert(`${selectedFiles.length}ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„: ${selectedFiles.join(", ")}`);
        });

        $("#fileSearch").on("input", function () {
            const folderId = $(".folder.selected").data("id");
            renderFileList(folderId, $(this).val());
        });

        $(document).on("change", ".selectAll", function () {
            $(".childCheckbox").prop("checked", $(this).is(":checked"));
        });

        $("#teammodal-form").on("submit", function (e) {
            e.preventDefault();
            const name = $("#teammodal-title").val().trim();
            const parentId = parseInt($("#parent-folder-select").val());
            if (!name || isNaN(parentId)) return;

            $.ajax({
                url: "/api/dataroom/addFolderAjax",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({name: name, parentId: parentId}),
                success: function () {
                    alert("í´ë”ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤");
                    $("#teammodal").hide();
                    loadFolders(); // ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                },
                error: function () {
                    alert("í´ë” ì¶”ê°€ ì‹¤íŒ¨");
                }
            });
        });

        // "íŒŒì¼ ì—…ë¡œë“œ" ë²„íŠ¼ í´ë¦­ ì‹œ ì—…ë¡œë“œ í¼ í† ê¸€
        $("#toggleUploadForm").on("click", function () {
            $uploadFormContainer.toggle();
        });

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
        $("#fileSelectBtn").on("click", function () {
            $fileInput.click();
        });

        // íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ ì´ë¦„ í‘œì‹œ
        $("#fileInput").on("change", function () {
            const fileName = $fileInput[0].files[0]?.name || "íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”";
            $fileNameDisplay.val(fileName);
        });
    });

</script>
</body>
</html>