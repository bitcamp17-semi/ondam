<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drive Storage</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/storage.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">ê³µìœ ë¬¸ì„œí•¨</div>
            <div class="navbar">
                <div id="navlist2">ë¬¸ì„œí•¨</div>
            </div>
        </div>
        <div class="section">
            <div class="leftarticle">
                <div class="orgaddbox">
                    <button class="addbtn" id="addteambtn">í´ë”ì¶”ê°€</button>
                </div>
                <div class="orgchart">
                    <ul class="tree" id="tree-root"></ul>
                </div>
            </div>
            <div class="rightarticle">
                <div class="righttop">
                    <input type="text" id="fileSearch" placeholder="íŒŒì¼ ê²€ìƒ‰...">
                    <button id="downloadSelected" class="whitebtn">ì„ íƒ ë‹¤ìš´ë¡œë“œ</button>
                    <button id="deleteSelected" class="whitebtn">ì„ íƒ ì‚­ì œ</button>
                </div>
                <div class="rightmain"></div>
            </div>
        </div>
    </div>

    <!-- í´ë” ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="teammodal">
        <form class="modal-form" id="teammodal-form">
            <div class="modal-content">
                <h2>í´ë” ì¶”ê°€</h2>
                <div class="modalteamtitle">
                    <span>ìƒìœ„ í´ë” ì„ íƒ</span>
                    <select id="parent-folder-select"></select>
                </div>
                <div class="modalteamtitle">
                    <span>í´ë” ì´ë¦„</span>
                    <input class="modaltitle" id="teammodal-title" type="text" placeholder="í´ë”ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
                </div>
                <div class="buttonset">
                    <button type="submit" class="submit-modal">ì¶”ê°€í•˜ê¸°</button>
                    <button type="button" class="close-modal" id="teamclose">ë‹«ê¸°</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const storageManager = {
        folderIdCounter: 10,
        folders: {
            1: { name: "ë¶€ì„œ1", children: [2, 5] },
            2: { name: "íŒ€A", children: [3, 4] },
            3: { name: "í•˜ìœ„í´ë”1", children: [] },
            4: { name: "í•˜ìœ„í´ë”2", children: [] },
            5: { name: "íŒ€B", children: [] }
        },
        files: {
            3: [
                { title: "íŒŒì¼1.docx", category: "ì¸ì‚¬", writer: "ê¹€ì‚¬ì›", date: "2025.04.01" },
                { title: "íŒŒì¼2.pdf", category: "ë³´ê³ ì„œ", writer: "ë°•ëŒ€ë¦¬", date: "2025.04.02" }
            ],
            4: [
                { title: "ìë£Œ1.xlsx", category: "íšŒê³„", writer: "ìµœê³¼ì¥", date: "2025.04.03" },
                { title: "ë³´ê³ ì„œ.hwp", category: "ê¸°íš", writer: "ì´ì£¼ì„", date: "2025.04.04" }
            ],
            5: [
                { title: "íŒ€B_ê³„íšì„œ.pptx", category: "ì „ëµ", writer: "í™ê¸¸ë™", date: "2025.04.05" }
            ]
        },
        addFolder(name, parentId) {
            const newId = this.folderIdCounter++;
            this.folders[newId] = { name, children: [] };
            this.folders[parentId].children.push(newId);
            return newId;
        },
        deleteFolder(id) {
            delete this.folders[id];
            for (const pid in this.folders) {
                this.folders[pid].children = this.folders[pid].children.filter(child => child !== id);
            }
        }
    };

    function renderFolderNode(folder) {
        const $li = $("<li>");
        const $span = $("<span>").addClass("folder").attr("data-id", folder.id).text(`ğŸ“ ${folder.name}`);

        // ìì‹ í´ë”ê°€ ìˆë‹¤ë©´ í™”ì‚´í‘œ ë¶™ì´ê¸°
        if (folder.hasChild) {
            $span.prepend('<i class="bi bi-chevron-right toggle-icon"></i> ');
        }

        $li.append($span);
        return $li;
    }


    function createFolderTree(id, activeId = null) {
        const folder = storageManager.folders[id];
        const $li = $("<li>");
        const $span = $("<span>").addClass("folder").attr("data-id", id);

        if (folder.children.length > 0) {
            $span.append('<i class="bi bi-chevron-right toggle-icon"></i> ');
        }
        $span.append(`ğŸ“ ${folder.name}`);
        const $deleteBtn = $('<i>').addClass('bi bi-x delete-folder').attr('data-id', id);
        $span.append($deleteBtn);
        $li.append($span);

        if (folder.children.length > 0) {
            const $ul = $("<ul>");
            folder.children.forEach(childId => $ul.append(createFolderTree(childId, activeId)));
            $li.append($ul);
        }

        if (id === activeId) {
            $li.addClass("open");
            $span.find(".toggle-icon").removeClass("bi-chevron-right").addClass("bi-chevron-down");
        }
        return $li;
    }

    function renderFolderTree(activeId = null) {
        $("#tree-root").empty().append(createFolderTree(1, activeId));
    }

    function renderFileList(folderId, query = "") {
        const files = (storageManager.files[folderId] || []).filter(f => f.title.toLowerCase().includes(query.toLowerCase()));

        if (!folderId) {
            $(".rightmain").html(`<div class='list-empty'>í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>`);
            return;
        }

        let htmlParts = [];
        htmlParts.push(`
        <div class="listtop">
            <input type="checkbox" class="selectAll list-cell">
            <div class="list-cell">ë²ˆí˜¸</div>
            <div class="list-cell listtitle">ì œëª©</div>
            <div class="list-cell">íŒŒì¼ë¶„ë¥˜</div>
            <div class="list-cell">ì‘ì„±ì</div>
            <div class="list-cell">ì‘ì„±ì¼</div>
            <div class="list-cell">ì‚­ì œ</div>
        </div>
        <div class="listmain">
    `);

        if (files.length === 0) {
            htmlParts.push(`<div class='list-empty' style='width: 100%; text-align: center; padding: 20px;'>íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>`);
        } else {
            files.forEach((f, i) => {
                htmlParts.push(`
                <div class="listcontent" data-index="${i}">
                    <input type="checkbox" class="childCheckbox list-cell">
                    <div class="list-cell">${i + 1}</div>
                    <div class="list-cell listtitle">${f.title}</div>
                    <div class="list-cell">${f.category}</div>
                    <div class="list-cell">${f.writer}</div>
                    <div class="list-cell">${f.date}</div>
                    <div class="list-cell"><i class="bi bi-trash3 filedelete"></i></div>
                </div>
            `);
            });
        }

        htmlParts.push("</div>");
        $(".rightmain").html(htmlParts.join(""));
    }

    function saveOpenFolders() {
        const openFolders = [];
        $("#tree-root .open > .folder").each(function () {
            openFolders.push($(this).data("id"));
        });
        localStorage.setItem("openFolders", JSON.stringify(openFolders));
    }

    $(document).ready(function () {
        renderFolderTree(); // ì´ˆê¸° ë Œë”ë§ ì‹œ ëª¨ë“  í´ë” ì ‘í˜

        let clickLocked = false;


        function loadFolders() {
            $.get("/api/dataroom/folders", function (folders) {
                storageManager.folders = {};
                folders.forEach(f => {
                    storageManager.folders[f.id] = { name: f.name, children: [] };
                });
                folders.forEach(f => {
                    if (f.parentId && storageManager.folders[f.parentId]) {
                        storageManager.folders[f.parentId].children.push(f.id);
                    }
                });
                renderFolderTree();
            });
        }

        $(document).on("click", ".folder", function (e) {
            if (clickLocked) return;
            clickLocked = true;
            setTimeout(() => clickLocked = false, 300);

            e.stopPropagation();
            $(".folder").removeClass("selected");
            $(this).addClass("selected");

            const $span = $(this);
            const $li = $span.closest("li");
            const folderId = $span.data("id");
            const $icon = $span.find(".toggle-icon");

            const isOpen = $li.hasClass("open");

            if (isOpen) {
                // í´ë” ë‹«ê¸°
                $li.removeClass("open");
                $li.children("ul").slideUp(200, () => {
                    $li.children("ul").remove();
                    $icon.removeClass("bi-chevron-down").addClass("bi-chevron-right");
                });
            } else {
                // í´ë” ì—´ê¸°
                const $existingUl = $li.children("ul");
                if ($existingUl.length > 0) {
                    $li.addClass("open");
                    $existingUl.slideDown(200, () => {
                        $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                    });
                } else {
                    // Ajaxë¡œ ìì‹ í´ë” ë¡œë”©
                    $.get(`/api/dataroom/subfolders/json/${folderId}`, function (subfolders) {
                        const $ul = $("<ul>");
                        subfolders.forEach(f => {
                            const $childLi = $("<li>");
                            const $childSpan = $("<span>").addClass("folder").attr("data-id", f.id).text(`ğŸ“ ${f.name}`);
                            if (f.hasChild) {
                                $childSpan.prepend('<i class="bi bi-chevron-right toggle-icon"></i> ');
                            }
                            $childLi.append($childSpan);
                            $ul.append($childLi);
                        });
                        $li.append($ul).addClass("open");
                        $icon.removeClass("bi-chevron-right").addClass("bi-chevron-down");
                    });
                }
            }

            renderFileList(folderId);
            saveOpenFolders();
        });


        $(document).on("dblclick", ".folder", function (e) {
            e.stopPropagation();
            const folderId = $(this).data("id");
            const currentName = storageManager.folders[folderId].name;
            const $span = $(this);
            const $input = $("<input>").val(currentName).css({ width: "100px" }).on("blur keypress", function (e) {
                if (e.type === "blur" || e.key === "Enter") {
                    const newName = $(this).val().trim();
                    if (newName && newName !== currentName) {
                        storageManager.folders[folderId].name = newName;
                        renderFolderTree(folderId); // ì—´ë¦° ìƒíƒœ ìœ ì§€
                    } else {
                        $span.html(`ğŸ“ ${currentName}`);
                    }
                }
            });
            $span.html($input);
            $input.focus();
        });

        $("#addteambtn").on("click", function () {
            const $select = $("#parent-folder-select").empty();
            function addOptions(id, prefix = "") {
                const folder = storageManager.folders[id];
                $select.append(`<option value="${id}">${prefix}${folder.name}</option>`);
                folder.children.forEach(childId => addOptions(childId, prefix + "â”” "));
            }
            addOptions(1);
            $("#teammodal").css("display", "flex");
        });

        $("#teamclose").on("click", () => $("#teammodal").css("display", "none")); // ì¤‘ë³µ ì œê±°

        $("#teammodal-form").on("submit", function (e) {
            e.preventDefault();
            const name = $("#teammodal-title").val().trim();
            const parentId = parseInt($("#parent-folder-select").val());
            if (!name || isNaN(parentId)) return;
            const newId = storageManager.addFolder(name, parentId);
            $("#teammodal").css("display", "none");
            $("#teammodal-title").val("");
            renderFolderTree(newId);
        });

        $(document).on("click", ".delete-folder", function (e) {
            e.stopPropagation();
            const folderId = $(this).data("id");
            const folder = storageManager.folders[folderId];
            const parentId = Object.entries(storageManager.folders).find(([_, v]) => v.children.includes(folderId))?.[0] || 1;

            if ((folder.children.length > 0) || (storageManager.files[folderId]?.length > 0)) {
                alert("í•˜ìœ„ í´ë”ë‚˜ íŒŒì¼ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            if (confirm("ì •ë§ ì´ í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                storageManager.deleteFolder(folderId);
                renderFolderTree();
                $(".rightmain").empty();
            }
        });

        $(document).on("click", ".filedelete", function () {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const folderId = $(".folder.selected").data("id");
            const index = parseInt($(this).closest(".listcontent").attr("data-index"));
            storageManager.files[folderId].splice(index, 1);
            renderFileList(folderId);
        });

        $("#deleteSelected").on("click", function () {
            if (!confirm("ì„ íƒí•œ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const folderId = $(".folder.selected").data("id");
            const indexes = $(".childCheckbox:checked").map((_, el) => parseInt($(el).closest(".listcontent").attr("data-index"))).get().sort((a, b) => b - a);
            if (!indexes.length) {
                alert("ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            indexes.forEach(i => storageManager.files[folderId].splice(i, 1));
            renderFileList(folderId);
        });

        $("#downloadSelected").on("click", function () {
            const folderId = $(".folder.selected").data("id");
            const selectedFiles = $(".childCheckbox:checked").map((_, el) => storageManager.files[folderId][parseInt($(el).closest(".listcontent").attr("data-index"))].title).get();
            if (!selectedFiles.length) {
                alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            console.log("ë‹¤ìš´ë¡œë“œ ìš”ì²­:", selectedFiles);
            alert(`${selectedFiles.length}ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„: ${selectedFiles.join(", ")}`);
        });

        $("#fileSearch").on("input", function () {
            const folderId = $(".folder.selected").data("id");
            renderFileList(folderId, $(this).val());
        });

        $(document).on("change", ".selectAll", function () {
            $(".childCheckbox").prop("checked", $(this).is(":checked"));
        });

        $("#teammodal-form").on("submit", function (e) {
            e.preventDefault();
            const name = $("#teammodal-title").val().trim();
            const parentId = parseInt($("#parent-folder-select").val());
            if (!name || isNaN(parentId)) return;

            $.ajax({
                url: "/api/dataroom/addFolderAjax",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ name: name, parentId: parentId }),
                success: function () {
                    alert("í´ë”ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤");
                    $("#teammodal").hide();
                    loadFolders(); // ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                },
                error: function () {
                    alert("í´ë” ì¶”ê°€ ì‹¤íŒ¨");
                }
            });
        });

    });
</script>

</body>
</html>