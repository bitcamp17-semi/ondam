<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/message_inbox.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div id="modal-overlay">
        <form id="modal-form">
            <div id="modal-content">
                <h2>ìª½ì§€ì“°ê¸°</h2>
                <input type="hidden" id="selectedUserId" name="selectedUserId" />
                <input type="hidden" id="userId" th:value="${session.loginUser != null ? session.loginUser.userId : ''}" />
                <div class="selectset">
                    <div class="dropdown" id="modaldepartment">
                        <span>ë¶€ì„œ</span>
                        <button class="dropdown-btn">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</button>
                        <div class="dropdown-menu">
                            <a href="#">ì˜µì…˜ 2-1</a>
                            <a href="#">ì˜µì…˜ 2-2</a>
                            <a href="#">ì˜µì…˜ 2-3</a>
                        </div>
                    </div>
                    <div class="dropdown" id="modalname">
                        <span>ì´ë¦„</span>
                        <button class="dropdown-btn">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</button>
                        <div class="dropdown-menu">
                            <a href="#">ì˜µì…˜ 3-1</a>
                            <a href="#">ì˜µì…˜ 3-2</a>
                            <a href="#">ì˜µì…˜ 3-3</a>
                        </div>
                    </div>
                </div>
                <div class="modalmessagetitle">
                    <span>ì œëª©</span>
                    <input id="modaltitle" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
                </div>
                <div class="modalmessagesection">
                    <span>ë‚´ìš©</span>
                    <textarea id="modalsection" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                </div>
                <div id="buttonset">
                    <button type="submit" id="submit-modal">ì „ì†¡í•˜ê¸°</button>
                    <button type="button" id="close-modal">ë‹«ê¸°</button>
                </div>
            </div>
        </form>
    </div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">
                ìª½ì§€ ë³´ê´€í•¨
            </div>
            <div class="navbar">
                <div id="navlist1">+ ìª½ì§€ì“°ê¸°</div>
                <div id="navlist2">ë°›ì€ ìª½ì§€í•¨</div>
                <div id="navlist3">ë³´ë‚¸ ìª½ì§€í•¨</div>
            </div>
        </div>
        <div class="section">
            <div class="leftarticle">
                <div id="totalcount">ì´ n ê°œì˜ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.</div>
                <div class="searchbox">
                    <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" id="searchinsert"/>
                    <button id="searchbtn">ê²€ìƒ‰</button>
                </div>
                <div class="dropdown">
                    <button class="dropdown-btn">ì •ë ¬ë°©ì‹</button>
                    <div class="dropdown-menu">
                        <a href="#" data-filter="all">ì „ì²´ë³´ê¸°</a>
                        <a href="#" data-filter="unread">ì•ˆ ì½ì€ ë©”ì„¸ì§€</a>

                    </div>
                </div>
                <input type="hidden" id="receiverId"
                       th:value="${session.loginUser?.userId}" />
                <div class="messages">
                    <div class="getmessage">
                        <div class="getmessage_first">
                            <div id="messagetitle">ì œëª©ì…ë‹ˆë‹¤</div>
                            <div id="messagedate">12.11.11</div>
                        </div>
                        <div id="messagename">ë³´ë‚¸ì‚¬ëŒ</div>
                        <div id="messagearticle">ë‚´ìš©ì…ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
            <div class="rightarticle">
                <div class="righttop">
                    <div class="listnumber">
                        <i class="bi bi-arrow-left leftbtn"></i>&nbsp&nbsp
                        <span id="pagenum">nowpage / totalpage</span>&nbsp&nbsp
                        <i class="bi bi-arrow-right rightbtn"></i>
                    </div>
                    <i class="bi bi-trash trashbox"></i>
                </div>
                <div class="rightmiddle">
                    <img src="" id="profilephoto"/>
                    <div class="profileset">
                        <span id="profilename">name</span>
                        <span id="profileteam">ë””ìì¸íŒ€ | ì‚¬ì›</span>
                    </div>
                    <div id="writedate">25. 03. 29 10:30AM</div>
                </div>
                <div class="rightmain">
                    <div id="rightmaintitle">
                        <i class="bi bi-suit-heart heart"></i>
                        ì œëª©ì…ë‹ˆë‹¤
                    </div>
                    <div id="rightmaincontents">ë‚´ìš©ì…ë‹ˆë‹¤</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        const receiverId = $("#receiverId").val();
        console.log("receiverId:", receiverId);
        const userId = $("#userId").val();
        console.log("userId: " + userId);


        // ===== ì¦ê²¨ì°¾ê¸° ìƒ‰ì¹  í† ê¸€ ê¸°ëŠ¥ =====
        $('.heart').click(function () {
            $(this).toggleClass('bi-suit-heart bi-suit-heart-fill');
        });

        // ===== ë“œë¡­ë‹¤ìš´ ê¸°ëŠ¥ =====
        $(".dropdown-btn").click(function (event) {
            event.stopPropagation();
            let dropdownContent = $(this).siblings(".dropdown-menu");
            $(".dropdown-menu").not(dropdownContent).hide();
            dropdownContent.toggle();
        });

        $(document).click(function () {
            $(".dropdown-menu").hide();
        });

        // ì„ íƒí•œ ì˜µì…˜ì„ ë²„íŠ¼ì— í‘œì‹œ
        $(".dropdown-menu a").click(function () {
            let selectedText = $(this).text();
            $(this).closest(".dropdown").find(".dropdown-btn").text(selectedText);
            $(this).closest(".dropdown-menu").hide(); // ì„ íƒ í›„ ë‹«ê¸°
        });

        // ===== ëª¨ë‹¬ ì—´ê¸° =====
        $('#navlist1').click(function () {
            $('#modal-overlay').css("display", "flex"); // ëª¨ë‹¬ í‘œì‹œ
        });

        // ===== ëª¨ë‹¬ ë‹«ê¸° =====
        $('#close-modal').click(function () {
            $('#modal-overlay').css("display", "none"); // ëª¨ë‹¬ ìˆ¨ê¹€
        });

        // ===== ëª¨ë‹¬ ë‚´ form ê¸°ë³¸ ì œì¶œ ë§‰ê¸° =====
        $("#modal-form").on("submit", function (e) {
            e.preventDefault(); // í˜ì´ì§€ ë¦¬ë¡œë“œ ë°©ì§€
        });


        $.ajax({
            url: "/messages/departments",
            method: "get",
            success: function (departments) {
                let $deptMenu = $("#modaldepartment .dropdown-menu");
                $deptMenu.empty();
                departments.forEach(dep => {
                    $deptMenu.append(`<a href="#" class="dept-option">${dep}</a>`);
                });
            }
        });
        $(document).on("click", ".dept-option", function (e) {
            let selectedDep = $(this).text();
            $("#modaldepartment .dropdown-btn").text(selectedDep);

            $.ajax({
                url: "/messages/userByDepartment",
                method: "get",
                data: {department: selectedDep},
                success: function (users) {
                    let $nameMenu = $("#modalname .dropdown-menu");
                    $nameMenu.empty();
                    users.forEach(user => {
                        $nameMenu.append(`<a href="#" class="user-option" data-userid="${user.id}">${user.name}</a>`);
                    });

                }
            });
        });

        let selectedUserId = null;
        $(document).on("click", ".user-option", function () {
            let name = $(this).text();
            let userId = $(this).data("userid");
            selectedUserId = $(this).data("userid");
            $("#modalname .dropdown-btn").text(name);
            $("#selectedUserId").val(userId); // âœ… ì—¬ê¸° ê³ ì¹¨
            console.log("ì„ íƒí•œ ì´ë¦„:", name);
            console.log("ì„ íƒí•œ ID:", userId);
        });


        $(document).on("click", "#submit-modal", function (e) {

            const selectedUserId = $("#selectedUserId").val();
            const title = $("#modaltitle").val();
            const content = $("#modalsection").val();
            console.log(selectedUserId, title, content);
            if (!selectedUserId || !title || !content) {
                alert("ëª¨ë“  í•­ëª©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }

            // AJAX ìš”ì²­ ë³´ë‚´ê¸°
            $.ajax({
                url: "/messages/createMessage",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    receiverId: selectedUserId,
                    title: title,
                    content: content
                }),
                success: function (response) {
                    alert("ìª½ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.");
                    // ëª¨ë‹¬ ë‹«ê³  ì´ˆê¸°í™”
                    $("#modal-overlay").hide();
                    $("#modaltitle").val("");
                    $("#modalsection").val("");
                    $("#selectedUserId").val("");
                    $("#selectedUserName").text("ì´ë¦„ ì„ íƒ");
                },
                error: function () {
                    alert("ìª½ì§€ ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        })
        $.ajax({
            url: "/messages/list",
            data: { receiverId: receiverId },
            method: "GET",
            success: function (data) {
                console.log("ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„°:", data);
                const container = $(".messages");
                $("#totalcount").text(`ì´ ${data.length}ê°œì˜ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);

                container.on("click", ".getmessage", function () {
                    const $this = $(this);
                    $("#rightmaintitle").text($this.data("title"));
                    $("#rightmaincontents").text($this.data("content"));
                    $("#profilename").text($this.data("name"));
                    $("#writedate").text($this.data("date"));
                });

                data.forEach(msg => {
                    const isRead = msg.isRead ? "read" : "unread";
                    const html = `
                        <div class="getmessage ${isRead}"
                            data-title="${msg.title}"
                            data-date="${formatDate(msg.createdAt)}"
                            data-name="${msg.senderName}"
                            data-content="${msg.content}">
                            <div class="getmessage_first">
                                <div>${msg.title}</div>
                                <div>${formatDate(msg.createdAt)}</div>
                            </div>
                            <div>${msg.senderName}</div>
                        </div>
                    `;
                    container.append(html);
                });
            },
            error: function (xhr, status, error) {
                console.error("ğŸ”¥ AJAX ì˜¤ë¥˜ ë°œìƒ ğŸ”¥");
                console.log("ìƒíƒœ ì½”ë“œ:", xhr.status);
                console.log("ì‘ë‹µ í…ìŠ¤íŠ¸:", xhr.responseText);
                console.log("ì—ëŸ¬ ë©”ì‹œì§€:", error);
            }

        });

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getFullYear().toString().slice(2)}.${d.getMonth() + 1}.${d.getDate()}`;
        }



    });


</script>
</body>
</html>