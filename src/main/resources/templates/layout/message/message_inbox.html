<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/message_inbox.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<input type="hidden" id="userId" th:value="${userId}" />
<input type="hidden" id="receiverId" th:value="${userId}"/>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div id="modal-overlay">
        <form id="modal-form">
            <div id="modal-content">
                <h2>ìª½ì§€ì“°ê¸°</h2>
                <div class="selectset">
                    <div class="dropdown" id="modaldepartment">
                        <span>ë¶€ì„œ</span>
                        <button class="dropdown-btn">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</button>
                        <div class="dropdown-menu">
                            <a href="#">ì˜µì…˜ 2-1</a>
                            <a href="#">ì˜µì…˜ 2-2</a>
                            <a href="#">ì˜µì…˜ 2-3</a>
                        </div>
                    </div>
                    <div class="dropdown" id="modalname">
                        <span>ì´ë¦„</span>
                        <button class="dropdown-btn">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</button>
                        <div class="dropdown-menu">
                            <a href="#">ì˜µì…˜ 3-1</a>
                            <a href="#">ì˜µì…˜ 3-2</a>
                            <a href="#">ì˜µì…˜ 3-3</a>
                        </div>
                    </div>
                </div>
                <div class="modalmessagetitle">
                    <span>ì œëª©</span>
                    <input id="modaltitle" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
                </div>
                <div class="modalmessagesection">
                    <span>ë‚´ìš©</span>
                    <textarea id="modalsection" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                </div>
                <div id="buttonset">
                    <button type="submit" id="submit-modal">ì „ì†¡í•˜ê¸°</button>
                    <button type="button" id="close-modal">ë‹«ê¸°</button>
                </div>
            </div>
        </form>
    </div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">
                ìª½ì§€ ë³´ê´€í•¨
            </div>
            <div class="navbar">
                <div id="navlist1">+ ìª½ì§€ì“°ê¸°</div>
                <div id="navlist2">ë°›ì€ ìª½ì§€í•¨</div>
                <div id="navlist3">ë³´ë‚¸ ìª½ì§€í•¨</div>
            </div>
        </div>
        <div class="section">
            <div class="leftarticle">
                <div id="totalcount">ì´ n ê°œì˜ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.</div>
                <div class="searchbox">
                    <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" id="searchinsert"/>
                    <button id="searchbtn">ê²€ìƒ‰</button>
                </div>
                <div class="dropdown">
                    <button class="dropdown-btn">ì •ë ¬ë°©ì‹</button>
                    <div class="dropdown-menu">
                        <a href="#" data-filter="all" class="selected">ì „ì²´ë³´ê¸°</a>
                        <a href="#" data-filter="important">ì¤‘ìš” ë©”ì„¸ì§€</a>
                    </div>
                </div>
                <div class="messages">
                    <div class="getmessage">
                        <div class="getmessage_first">
                            <div id="messagetitle"></div>
                            <div id="messagedate"></div>
                        </div>
                        <div id="messagename"></div>
                        <div id="messagearticle"></div>
                    </div>
                </div>
            </div>
            <div class="rightarticle">
                <div class="righttop">
                    <div class="listnumber">
                        <i class="bi bi-arrow-left leftbtn"></i>&nbsp&nbsp
                        <span id="pagenum">ì´ì „ / ë‹¤ìŒ</span>&nbsp&nbsp
                        <i class="bi bi-arrow-right rightbtn"></i>
                    </div>
                    <i class="bi bi-trash trashbox"></i>
                </div>
                <div class="rightmiddle">
                    <img src="" id="profilephoto"/>
                    <div class="profileset">
                        <span id="profilename">name</span>
                        <span id="profileteam">ë””ìì¸íŒ€ | ì‚¬ì›</span>
                    </div>
                    <div id="writedate">25. 03. 29 10:30AM</div>
                </div>
                <div class="rightmain">
                    <div id="rightmaintitle" data-message-id="" data-createAt="2025-04-10T14:25:36">
                       <span class="title-text">ì œëª©ì…ë‹ˆë‹¤</span>
                       <i class="bi bi-suit-heart heart"></i>
                    </div>
                    <div id="rightmaincontents">ë‚´ìš©ì…ë‹ˆë‹¤</div>
                </div>

                </div>
            </div>
        </div>
    </div>
<script>
    let currentMessageCreatedAt = null;
    let page = 0; // í˜ì´ì§€
    let currentPage = 0;
    let loading = false; //ë¡œë”©ìƒíƒœ
    let messages = []; //ë©”ì„¸ì§€ ëª©ë¡
    let totalMessages = 0; // ì´ë©”ì„¸ì§€ ê°œìˆ˜
    let currentFilter = "all";
    $(document).ready(function () {
        const receiverId = $("#receiverId").val();
        console.log("receiverId:", receiverId);
        const userId = $("#userId").val();
        console.log("userId: " + userId);
        loadMessages("all", receiverId);
        $("#rightmaintitle .title-text").text("");
        $("#rightmaincontents").text("");
        $("#profilename").text("");
        $("#writedate").text("");
        $("#profileteam").text("");
        $("#profilephoto").attr("src", ""); // í”„ë¡œí•„ ì‚¬ì§„ ì´ˆê¸°í™”
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ "ì „ì²´ë³´ê¸°"ë¥¼ ì„ íƒëœ ìƒíƒœë¡œ ì„¤ì •
        $(".dropdown-menu a[data-filter='all']").addClass("selected");
        $(".dropdown-btn").text("ì „ì²´ë³´ê¸°");


        function formatDateTime(isoString) {
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function renderMessageDetail(msg) {
            $("#rightmaincontents").text(msg.content);
            $("#rightmaintitle .title-text").text(msg.title);
            $("#rightmaintitle").attr("data-message-id", msg.id);
            $("#rightmaintitle").attr("data-createAt", msg.createdAt);


            // ì¤‘ìš” í‘œì‹œ
            const $heart = $("#rightmaintitle .heart");
            $heart
                .removeClass("bi-suit-heart bi-suit-heart-fill")
                .addClass(msg.isImportant ? "bi-suit-heart-fill" : "bi-suit-heart")
                .attr("data-id", msg.id);

            // ë‚ ì§œ í¬ë§·
            const formatted = formatDateTime(msg.createdAt);
            $("#writedate").text(formatted);

            // ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
            $.get("/messages/users/name", {id: msg.senderId}, function (name) {
                $("#profilename").text(name);
            });
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ í›„ ì˜¤ë¥¸ìª½ íŒ¨ë„ ì´ˆê¸°í™”
        function resetMessageDetailPanel() {
            $("#rightmaincontents").text("");
            $("#rightmaintitle .title-text").text("");
            $("#rightmaintitle").attr("data-message-id", "");
            $("#rightmaintitle").attr("data-createAt", "");
            $("#writedate").text("");
            $("#profilename").text("");
            $("#profileteam").text("");
            $("#profilephoto").attr("src", "").hide();
            $(".heart").hide();
            $(".rightarticle").removeClass("show-detail");
        }


        function createSentMessageHTML(msg) {
            const isImportant = msg.isImportant;
            const starIcon = isImportant ? "bi-star-fill" : "bi-star";
            const title = msg.title ?? "ì œëª© ì—†ìŒ";
            const date = formatDate(msg.createdAt);
            const receiver = msg.receiverName ?? "ì•Œ ìˆ˜ ì—†ìŒ";
            const content = msg.content.length > 30 ? msg.content.slice(0, 30) + "..." : msg.content;

            return `
                <div class="getmessage read"
                     data-id="${msg.id}"
                     data-sent="true"
                     data-title="${title}"
                     data-date="${date}"
                     data-name="${receiver}"
                     data-content="${msg.content}"
                     data-important="${isImportant}">
                    <div class="getmessage_first" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: normal; font-size: 16px;">${title}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi ${starIcon} important-icon" data-id="${msg.id}" style="cursor: pointer;"></i>
                            <div style="font-size: 12px; color: gray;">${date}</div>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #444;">To. ${receiver}</div>
                    <div style="font-size: 13px; color: #666;">${content}</div>
                </div>
                `;
        }


        function resetDetailView() {
            $("#rightmaintitle .title-text").text('');
            $("#rightmaincontents").text('');
            $("#profilename").text('');
            $("#profileteam").text('');
            $("#profilephoto").attr('src', '').hide();
            $("#writedate").text('');
            $(".heart").hide();
        }


        $("#searchbtn").on("click", function (e) {
            e.preventDefault();

            let keyword = $("#searchinsert").val().trim();
            let category = $(".dropdown-menu a.selected").data("filter") || "all";
            const userId = $("#userId").val();

            resetMessageDetailPanel(); // âœ… ë¬´ì¡°ê±´ ê²€ìƒ‰ ì „ì— í•œ ë²ˆ ì´ˆê¸°í™”

            if (keyword === "") {
                $("#receiverId").val(userId);
                loadMessages(category, userId); // âœ… ì „ì²´ ë©”ì‹œì§€ ë³´ê¸°
            } else {
                $.get("/messages/search", {
                    keyword: keyword,
                    category: category === "important" ? "IMPORTANT" : "LATEST",
                    receiverId: $("#userId").val()
                }, function (res) {
                    $(".messages").empty();
                    if (res.status === "ok") {
                        if (res.result.length === 0) {
                            $(".messages").append(`
                        <div class="no-result" style="padding: 20px; text-align: center; color: #888;">
                            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `);
                        } else {
                            res.result.forEach(msg => {
                                $(".messages").append(createMessageHTML(msg, true)); // â† ê²€ìƒ‰ê²°ê³¼ëŠ” ê°•ì œ ì½ìŒ ì²˜ë¦¬
                            });
                        }
                        $("#totalcount").text(`ì´ ${res.result.length}ê°œì˜ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);
                    } else {
                        alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + res.message);
                    }
                });
            }
        });


        // ë°›ì€ ìª½ì§€í•¨
        // ë°›ì€ ìª½ì§€í•¨ í´ë¦­ ì‹œ
        $("#navlist2").on("click", function () {
            $("#navlist2").css("font-weight", "bold");
            $("#navlist3").css("font-weight", "normal");

            resetMessageDetailPanel();
            const userId = $("#userId").val();

            $.get("/messages/inbox", { receiverId: userId }, function (res) {
                if (res.status === "ok") {
                    $(".messages").empty();

                    if (res.result.length === 0) {
                        $(".messages").append(`<div class="no-result">ë°›ì€ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
                    } else {
                        res.result.forEach(msg => {
                            $(".messages").append(createMessageHTML(msg)); // âœ… ë°›ì€ ë©”ì‹œì§€
                        });
                    }

                    $("#totalcount").text(`ì´ ${res.result.length}ê°œì˜ ë°›ì€ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);
                }
            });
        });


// ë³´ë‚¸ ìª½ì§€í•¨
        // ë³´ë‚¸ ìª½ì§€í•¨ í´ë¦­ ì‹œ
        $("#navlist3").on("click", function () {
            $("#navlist3").css("font-weight", "bold");
            $("#navlist2").css("font-weight", "normal");

            resetMessageDetailPanel();
            const userId = $("#userId").val();

            $.get("/messages/sent", { senderId: userId }, function (res) {
                if (res.status === "ok") {
                    $(".messages").empty();

                    if (res.result.length === 0) {
                        $(".messages").append(`<div class="no-result">ë³´ë‚¸ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
                    } else {
                        res.result.forEach(msg => {
                            $(".messages").append(createSentMessageHTML(msg)); // âœ… ë³´ë‚¸ ë©”ì‹œì§€
                        });
                    }

                    $("#totalcount").text(`ì´ ${res.result.length}ê°œì˜ ë³´ë‚¸ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);
                }
            });
        });



        // ===== ì¦ê²¨ì°¾ê¸° ìƒ‰ì¹  í† ê¸€ ê¸°ëŠ¥ =====
        $('.heart').click(function (e) {
            e.preventDefault();

            $(this).toggleClass('bi-suit-heart bi-suit-heart-fill');
        });

        // ===== ë“œë¡­ë‹¤ìš´ ê¸°ëŠ¥ =====
        $(".dropdown-btn").click(function (event) {
            event.stopPropagation();
            let dropdownContent = $(this).siblings(".dropdown-menu");
            $(".dropdown-menu").not(dropdownContent).hide();
            dropdownContent.toggle();
        });
        $(document).click(function (e) {
            e.preventDefault();
            $(".dropdown-menu").hide();
        });

        // ì„ íƒí•œ ì˜µì…˜ì„ ë²„íŠ¼ì— í‘œì‹œ
        $(".dropdown-menu a").on("click", function (e) {
            e.preventDefault();

            let selectedText = $(this).text();
            // ì„ íƒëœ í•­ëª©ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€í•˜ê³ , ë‹¤ë¥¸ í•­ëª©ì—ì„œëŠ” ì œê±°
            $(this).addClass("selected").siblings().removeClass("selected");

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ì„ íƒëœ í•­ëª© í…ìŠ¤íŠ¸ë¡œ ë³€ê²½
            $(this).closest(".dropdown").find(".dropdown-btn").text(selectedText);

            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            $(this).closest(".dropdown-menu").hide();
        });


        // ===== ëª¨ë‹¬ ì—´ê¸° =====
        $('#navlist1').click(function (e) {
            e.preventDefault();

            $('#modal-overlay').css("display", "flex"); // ëª¨ë‹¬ í‘œì‹œ
        });

        // ===== ëª¨ë‹¬ ë‹«ê¸° =====
        $('#close-modal').click(function (e) {
            e.preventDefault();

            $('#modal-overlay').css("display", "none"); // ëª¨ë‹¬ ìˆ¨ê¹€
        });

        // ===== ëª¨ë‹¬ ë‚´ form ê¸°ë³¸ ì œì¶œ ë§‰ê¸° =====
        $("#modal-form").on("submit", function (e) {
            e.preventDefault(); // í˜ì´ì§€ ë¦¬ë¡œë“œ ë°©ì§€
        });


        $.ajax({
            url: "/messages/departments",
            method: "get",
            success: function (departments) {
                let $deptMenu = $("#modaldepartment .dropdown-menu");
                $deptMenu.empty();
                departments.forEach(dep => {
                    $deptMenu.append(`<a href="#" class="dept-option">${dep}</a>`);
                });
            }
        });
        $(document).on("click", ".dept-option", function (e) {
            e.preventDefault();

            let selectedDep = $(this).text();
            $("#modaldepartment .dropdown-btn").text(selectedDep);

            $.ajax({
                url: "/messages/userByDepartment",
                method: "get",
                data: {department: selectedDep},
                success: function (users) {
                    let $nameMenu = $("#modalname .dropdown-menu");
                    $nameMenu.empty();

                    users.forEach(user => {
                        $nameMenu.append(`<a href="#" class="user-option" data-userid="${user.id}">${user.name}</a>`);
                    });

                    $("#modalname .dropdown-btn").text("ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”");
                    $("#receiverId").val(""); // ì´ì „ ì„ íƒ ì œê±°
                }
            });
        });

        // âœ… ì¤‘ë³µ ì œê±° í›„ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        $(document).off("click", ".user-option").on("click", ".user-option", function () {
            let name = $(this).text();
            let userId = $(this).data("userid");

            $("#modalname .dropdown-btn").text(name);
            $("#receiverId").val(userId);
        });


        $(document).on("click", ".user-option", function (e) {
            e.preventDefault();

            let name = $(this).text();
            let userId = $(this).data("userid");

            $("#modalname .dropdown-btn").text(name);
            $("#receiverId").val(userId); // âœ… receiverId ë¡œ ë°”ë¡œ ëŒ€ì…
        });


        $(document).on("click", "#submit-modal", function (e) {
            e.preventDefault();

            const senderId = $("#userId").val();
            const receiverId = $("#receiverId").val();
            const title = $("#modaltitle").val();
            const content = $("#modalsection").val();

            console.log(receiverId, title, content);

            if (!receiverId || !title || !content) {
                alert("ëª¨ë“  í•­ëª©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }

            $.ajax({
                url: "/messages/createMessage",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    senderId: senderId,
                    receiverId: receiverId,
                    title: title,
                    content: content
                }),
                success: function (response) {
                    alert("ìª½ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.");
                    $("#modal-overlay").hide();
                    $("#modaltitle").val("");
                    $("#modalsection").val("");
                    /*$("#receiverId").val("");*/
                    $("#modalname .dropdown-btn").text("ì´ë¦„ ì„ íƒ");

                    loadMessages("all", userId); // âœ… ìƒˆë¡œê³ ì¹¨
                },
                error: function () {
                    alert("ìª½ì§€ ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });


        // ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ ì‹œ
        $(document).on("click", ".dropdown-menu a", function (e) {
            e.preventDefault();

            const filter = $(this).data("filter");
            $(this).closest(".dropdown").find(".dropdown-btn").text($(this).text());
            const userId = $("#userId").val();
            loadMessages(filter, userId);
        });

        // ì¤‘ìš” í‘œì‹œ í† ê¸€
        $(document).on("click", ".important-icon", function (e) {
            e.stopPropagation();
            const icon = $(this);
            const messageId = icon.data("id");
            const isNowImportant = icon.hasClass("bi-star-fill");

            $.ajax({
                url: `/messages/important/${messageId}`,
                method: "POST",
                data: {isImportant: !isNowImportant},
                success: function () {
                    icon.toggleClass("bi-star bi-star-fill");
                },
                error: function () {
                    alert("ì¤‘ìš” í‘œì‹œ ë³€ê²½ ì‹¤íŒ¨");
                },
            });
        });

        // ë©”ì‹œì§€ í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸° í‘œì‹œ
        $(document).on("click", ".getmessage", function (e) {
            e.preventDefault();
            const $this = $(this);
            const messageId = $this.data("id");
            const isSent = $this.data("sent") === true || $this.data("sent") === "true";

            resetMessageDetailPanel();

            if (isSent) {
                // âœ… ë³´ë‚¸ ë©”ì‹œì§€
                $.get(`/messages/${messageId}`, function (res) {
                    if (res.status === "ok") {
                        const msg = res.result;
                        $("#rightmaintitle .title-text").text(msg.title);
                        $("#rightmaincontents").text(msg.content);
                        $("#rightmaintitle").attr("data-message-id", msg.id);
                        $("#rightmaintitle").attr("data-createAt", msg.createdAt);

                        const date = formatDateTime(msg.createdAt);
                        $("#writedate").text(date);

                        // ìˆ˜ì‹ ì ì´ë¦„
                        $.get("/messages/users/name", {id: msg.receiverId}, function (name) {
                            $("#profilename").text(name);
                        });

                        $("#profileteam").text("ìˆ˜ì‹ ì");
                        $("#profilephoto").hide();
                        $(".heart").hide();
                        $(".rightarticle").addClass("show-detail");
                    }
                });
            } else {
                // âœ… ë°›ì€ ë©”ì‹œì§€
                const isImportant = $this.find(".important-icon").hasClass("bi-star-fill");

                const $heart = $("#rightmaintitle .heart")
                    .removeClass("bi-suit-heart bi-suit-heart-fill")
                    .addClass(isImportant ? "bi-suit-heart-fill" : "bi-suit-heart")
                    .attr("data-id", messageId);

                $("#rightmaintitle").attr("data-message-id", messageId);
                $("#rightmaincontents").text($this.data("content"));
                $("#rightmaintitle .title-text").text($this.data("title"));
                $("#writedate").text($this.data("date"));

                $("#profilename,#profileteam, #profilephoto, .heart").show();

                $.get(`/messages/${messageId}`, function (response) {
                    if (response.status === "ok") {
                        const msg = response.result;

                        $.get(`/api/users/readUserById?userId=${msg.senderId}`, function (userRes) {
                            if (userRes.status === "ok") {
                                const userData = userRes.result;
                                $("#profilename").text(userData.name);
                                $("#profilephoto").show().attr("src", `https://kr.object.ncloudstorage.com/bitcamp-semi/users/${userData.profileImage}`);
                                $("#profilephoto").on("error", function () {
                                    $(this).attr("src", "../../images/Rectangle53.png");
                                });

                                $.get("/api/dep/readDeps", function (depRes) {
                                    if (depRes.status === "ok") {
                                        const department = depRes.result.find(dep => dep.id == userData.departmentId);
                                        if (userData.position === "admin") {
                                            $("#profileteam").text("ê´€ë¦¬ì");
                                        } else if (department) {
                                            $("#profileteam").text(`${department.name} | ${userData.position}`);
                                        }
                                    }
                                });
                            }
                        });

                        $(".rightarticle").addClass("show-detail");
                    }
                });

                // ì½ìŒ ì²˜ë¦¬
                $.post(`/messages/read/${messageId}`, function () {
                    $this.removeClass("unread").addClass("read");
                    $this.find(".getmessage_first div:first-child").css("font-weight", "normal");
                });
            }
        });


        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getFullYear().toString().slice(2)}.${d.getMonth() + 1}.${d.getDate()}`;
        }

        function createMessageHTML(msg, isSearchResult = false) {
            const isRead = msg.isRead;
            const isImportant = msg.isImportant;
            const starIcon = isImportant ? "bi-star-fill" : "bi-star";

            const readClass = isSearchResult ? "read" : (isRead ? "read" : "unread");

            const title = msg.title ?? "ì œëª© ì—†ìŒ";
            const date = formatDate(msg.createdAt);
            const sender = msg.senderName || msg.receiverName || "ì•Œ ìˆ˜ ì—†ìŒ";
            const content = msg.content.length > 30 ? msg.content.slice(0, 30) + "..." : msg.content;

            return `
                <div class="getmessage ${readClass}"
                     data-id="${msg.id}"
                     data-sent="false"
                     data-title="${title}"
                     data-date="${date}"
                     data-name="${sender}"
                     data-content="${msg.content}"
                     data-important="${isImportant}">
                    <div class="getmessage_first" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: ${readClass === "unread" ? "bold" : "normal"}; font-size: 16px;">${title}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="bi ${starIcon} important-icon" data-id="${msg.id}" style="cursor: pointer;"></i>
                            <div style="font-size: 12px; color: gray;">${date}</div>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #444;">${sender}</div>
                    <div style="font-size: 13px; color: #666;">${content}</div>
                </div>
            `;
        }


        function loadMessages(filter, userId) {
            currentFilter = filter;
            page = 0;
            $(".messages").empty();
            loadMoreMessages(filter, userId);
        }

        // âœ… ë¬´í•œ ìŠ¤í¬ë¡¤ ë° í•„í„°ë§ ì²˜ë¦¬
        function loadMoreMessages(filter, userId) {
            if (loading) return;
            loading = true;

            $.ajax({
                url: "/messages/list",
                method: "GET",
                data: {
                    receiverId: userId, // ğŸ”¥ ì—¬ê¸°ê°€ í•µì‹¬
                    page: page,
                    size: 10,
                    filter: filter,
                },
                success: function (data) {
                    const container = $(".messages");

                    let filtered = filter === "important" ? data.filter(m => m.isImportant) : data;

                    if (filtered.length === 0) return;

                    // ìª½ì§€ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                    $("#totalcount").text(`ì´ ${filtered.length} ê°œì˜ ìª½ì§€ê°€ ìˆìŠµë‹ˆë‹¤.`);

                    filtered.forEach(msg => {
                        container.append(createMessageHTML(msg));
                    });

                    page++;
                    loading = false;
                },
                error: function (xhr) {
                    console.error("ğŸ”¥ ë¬´í•œìŠ¤í¬ë¡¤ AJAX ì˜¤ë¥˜ ğŸ”¥", xhr.responseText);
                    loading = false;
                }
            });
        }

        $(".leftbtn").on("click", function (e) {
            e.preventDefault();  // âœ… ê¸°ë³¸ ì œì¶œ/ì´ë™ ë°©ì§€
            const currentTime = $("#rightmaintitle").attr("data-createAt"); // í˜„ì¬ ë³´ê³  ìˆëŠ” ë©”ì‹œì§€ ì‹œê°„
            const receiverId = $("#receiverId").val();

            $.get("/messages/prev", {
                receiverId: receiverId,
                currentCreatedAt: currentTime
            }, function (res) {
                if (res.status === "ok" && res.result) {
                    const msg = res.result;
                    renderMessageDetail(msg);
                } else {
                    alert("ì´ì „ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        });

        $(".rightbtn").on("click", function (e) {
            e.preventDefault();  // âœ… ê¸°ë³¸ ì œì¶œ/ì´ë™ ë°©ì§€
            const currentTime = $("#rightmaintitle").attr("data-createAt");
            const receiverId = $("#receiverId").val();

            $.get("/messages/next", {
                receiverId: receiverId,
                currentCreatedAt: currentTime
            }, function (res) {
                if (res.status === "ok" && res.result) {
                    renderMessageDetail(res.result);
                } else {
                    alert("ë‹¤ìŒ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        });


        $(window).on("scroll", function () {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                const userId = $("#userId").val();
                loadMoreMessages(currentFilter, userId);
            }
        });


        $(document).on("click", "#rightmaintitle .heart", function (e) {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            e.preventDefault();   // ê¸°ë³¸ ë™ì‘ ë°©ì§€

            const $heart = $(this);
            const messageId = $heart.attr("data-id") || $heart.data("id");

            console.log("ğŸ§ª messageId:", messageId);

            if (!messageId) return alert("âŒ ë©”ì‹œì§€ IDê°€ ì—†ìŠµë‹ˆë‹¤!");

            const isImportant = $heart.hasClass("bi-suit-heart-fill");
            const isNowImportant = !isImportant;

            // ì¤‘ìš” í‘œì‹œ AJAX
            $.ajax({
                url: `/messages/important/${messageId}`,
                method: "POST",
                data: {isImportant: isNowImportant},
                success: function () {
                    // ì¤‘ìš” í‘œì‹œ ìƒíƒœ ë°˜ì˜
                    $heart
                        .removeClass("bi-suit-heart bi-suit-heart-fill")
                        .addClass(isNowImportant ? "bi-suit-heart-fill" : "bi-suit-heart");

                    // ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ë°˜ì˜
                    const $listHeart = $(`.important-icon[data-id="${messageId}"]`);
                    $listHeart
                        .removeClass("bi-star bi-star-fill")
                        .addClass(isNowImportant ? "bi-star-fill" : "bi-star");

                    // .getmessage ë°ì´í„°ì—ë„ ë°˜ì˜
                    $(`.getmessage[data-id="${messageId}"]`).data("important", isNowImportant);
                },
                error: function () {
                    alert("ì¤‘ìš” í‘œì‹œ ì‹¤íŒ¨");
                }
            });
        });

        $(document).on("click", ".trashbox", function () {
            e.preventDefault();
            const messageItem = $(this).closest(".message-item");
            const messageId = $("#rightmaintitle").data("message-id");  // rightmaintitleì—ì„œ ë©”ì‹œì§€ ID ì°¾ê¸°

            console.log("messageItem:", messageItem);  // messageItem í™•ì¸
            console.log("ì‚­ì œí•  ë©”ì‹œì§€ ID:", messageId);  // ë©”ì‹œì§€ ID í™•ì¸

            // messageIdê°€ undefinedì¼ ê²½ìš° ê²½ê³ í•˜ê³  ì¢…ë£Œ
            if (messageId === undefined) {
                console.error("ë©”ì‹œì§€ IDê°€ ì—†ìŠµë‹ˆë‹¤. 'data-id'ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
                alert("ë©”ì‹œì§€ IDê°€ ì—†ì–´ì„œ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;  // ì‚­ì œ ìš”ì²­ ì¤‘ë‹¨
            }

            if (confirm("ì •ë§ë¡œ ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                console.log("ì‚­ì œ í™•ì¸ë¨");

                // YES! ì‚­ì œ ìš”ì²­d
                $.ajax({
                    url: `/messages/${messageId}`,
                    method: "DELETE",
                    success: function (response) {
                        console.log("ì‚­ì œ ì„±ê³µ ì‘ë‹µ:", response);  // 2. ì‚­ì œ ì„±ê³µ ì‘ë‹µ í™•ì¸
                        if (response.status === "ok") {
                            // ì‚­ì œëœ ë©”ì‹œì§€ í•­ëª©ì„ í™”ë©´ì—ì„œ ì œê±°
                            messageItem.remove();
                            console.log("ë©”ì‹œì§€ í•­ëª© ì‚­ì œ ì™„ë£Œ");

                            // ë©”ì‹œì§€ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´
                            const currentFilter = $(".dropdown-btn").text().toLowerCase(); // í˜„ì¬ í•„í„° ê°€ì ¸ì˜¤ê¸°
                            const receiverId = $("#receiverId").val(); // ë°›ëŠ” ì‚¬ëŒ ID ê°€ì ¸ì˜¤ê¸°

                            console.log("í˜„ì¬ í•„í„°:", currentFilter);
                            console.log("ë°›ëŠ” ì‚¬ëŒ ID:", receiverId);

                            if (currentFilter && receiverId) {
                                loadMessages(currentFilter, receiverId);  // ëª©ë¡ì„ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                            } else {
                                console.error("í•„í„°ë‚˜ ë°›ëŠ” ì‚¬ëŒ IDê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            }

                            // ë§Œì•½ í˜„ì¬ ë³´ê³  ìˆëŠ” ë©”ì‹œì§€ê°€ ì‚­ì œëœ ë©”ì‹œì§€ë¼ë©´, í™”ë©´ ì´ˆê¸°í™”
                            const currentMessageId = $("#rightmaintitle").data("message-id");
                            console.log("í˜„ì¬ ë³´ê³  ìˆëŠ” ë©”ì‹œì§€ ID:", currentMessageId);

                            if (currentMessageId == messageId) {
                                // ë©”ì‹œì§€ê°€ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ í™”ë©´ ì´ˆê¸°í™”
                                console.log("í˜„ì¬ ë³´ê³  ìˆëŠ” ë©”ì‹œì§€ê°€ ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤. í™”ë©´ ì´ˆê¸°í™”...");
                                $("#rightmaintitle .title-text").text('');
                                $("#rightmaincontents").text('');
                                $("#profilename").text('');
                                $("#profileteam").text('');
                                $("#profilephoto").attr('src', '');
                                $("#profilephoto").hide();
                                $("#writedate").text('');
                                $(".heart").hide();
                            }

                            alert(response.message);  // ì‚­ì œ ì™„ë£Œ ë©”ì‹œì§€
                        } else {
                            console.log("ì‚­ì œ ì‹¤íŒ¨ ë©”ì‹œì§€:", response.message);
                            alert("ì‚­ì œ ì‹¤íŒ¨: " + response.message);
                        }
                    },
                    error: function (err) {
                        console.log("ì‚­ì œ ì‹¤íŒ¨ ì˜¤ë¥˜:", err);  // 3. ì‚­ì œ ì‹¤íŒ¨ ì˜¤ë¥˜ í™•ì¸
                        alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
                    }
                });
            }
        });
        $("#searchinsert").on("keypress", function (e) {
            if (e.which === 13) { // Enter í‚¤
                e.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                $("#searchbtn").click(); // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í˜¸ì¶œ
            }
        });
    });




</script>
</body>
</html>