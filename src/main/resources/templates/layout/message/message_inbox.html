<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/message_inbox.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div id="modal-overlay">
        <form id="modal-form">
            <div id="modal-content">
                <h2>쪽지쓰기</h2>
                <input type="hidden" id="receiverId" th:value="${userId}" />
                <input type="hidden" id="userId" th:value="${userId}" />
                <div class="selectset">
                    <div class="dropdown" id="modaldepartment">
                        <span>부서</span>
                        <button class="dropdown-btn">부서를 선택하세요</button>
                        <div class="dropdown-menu">
                            <a href="#">옵션 2-1</a>
                            <a href="#">옵션 2-2</a>
                            <a href="#">옵션 2-3</a>
                        </div>
                    </div>
                    <div class="dropdown" id="modalname">
                        <span>이름</span>
                        <button class="dropdown-btn">이름을 선택하세요</button>
                        <div class="dropdown-menu">
                            <a href="#">옵션 3-1</a>
                            <a href="#">옵션 3-2</a>
                            <a href="#">옵션 3-3</a>
                        </div>
                    </div>
                </div>
                <div class="modalmessagetitle">
                    <span>제목</span>
                    <input id="modaltitle" type="text" placeholder="제목을 입력해주세요"/>
                </div>
                <div class="modalmessagesection">
                    <span>내용</span>
                    <textarea id="modalsection" placeholder="내용을 입력해주세요"></textarea>
                </div>
                <div id="buttonset">
                    <button type="submit" id="submit-modal">전송하기</button>
                    <button type="button" id="close-modal">닫기</button>
                </div>
            </div>
        </form>
    </div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">
                쪽지 보관함
            </div>
            <div class="navbar">
                <div id="navlist1">+ 쪽지쓰기</div>
                <div id="navlist2">받은 쪽지함</div>
                <div id="navlist3">보낸 쪽지함</div>
            </div>
        </div>
        <div class="section">
            <div class="leftarticle">
                <div id="totalcount">총 n 개의 쪽지가 있습니다.</div>
                <div class="searchbox">
                    <input type="text" placeholder="검색어를 입력하세요" id="searchinsert"/>
                    <button id="searchbtn">검색</button>
                </div>
                <div class="dropdown">
                    <button class="dropdown-btn">정렬방식</button>
                    <div class="dropdown-menu">
                        <a href="#" data-filter="all">전체보기</a>
                        <a href="#" data-filter="unread">안 읽은 메세지</a>
                        <a href="#" data-filter="important">중요 메세지</a>
                    </div>
                </div>
                <div class="messages">
                    <div class="getmessage">
                        <div class="getmessage_first">
                            <div id="messagetitle"></div>
                            <div id="messagedate"></div>
                        </div>
                        <div id="messagename"></div>
                        <div id="messagearticle"></div>
                    </div>
                </div>
            </div>
            <div class="rightarticle">
                <div class="righttop">
                    <div class="listnumber">
                        <i class="bi bi-arrow-left leftbtn"></i>&nbsp&nbsp
                        <span id="pagenum">nowpage / totalpage</span>&nbsp&nbsp
                        <i class="bi bi-arrow-right rightbtn"></i>
                    </div>
                    <i class="bi bi-trash trashbox"></i>
                </div>
                <div class="rightmiddle">
                    <img src="" id="profilephoto"/>
                    <div class="profileset">
                        <span id="profilename">name</span>
                        <span id="profileteam">디자인팀 | 사원</span>
                    </div>
                    <div id="writedate">25. 03. 29 10:30AM</div>
                </div>
                <div class="rightmain">
                    <div id="rightmaintitle">
                        <i class="bi bi-suit-heart heart"></i>
                        제목입니다
                    </div>
                    <div id="rightmaincontents">내용입니다</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {

        const receiverId = $("#receiverId").val();
        console.log("receiverId:", receiverId);
        const userId = $("#userId").val();
        console.log("userId: " + userId);


        // ===== 즐겨찾기 색칠 토글 기능 =====
        $('.heart').click(function () {
            $(this).toggleClass('bi-suit-heart bi-suit-heart-fill');
        });

        // ===== 드롭다운 기능 =====
        $(".dropdown-btn").click(function (event) {
            event.stopPropagation();
            let dropdownContent = $(this).siblings(".dropdown-menu");
            $(".dropdown-menu").not(dropdownContent).hide();
            dropdownContent.toggle();
        });

        $(document).click(function () {
            $(".dropdown-menu").hide();
        });

        // 선택한 옵션을 버튼에 표시
        $(".dropdown-menu a").click(function () {
            let selectedText = $(this).text();
            $(this).closest(".dropdown").find(".dropdown-btn").text(selectedText);
            $(this).closest(".dropdown-menu").hide(); // 선택 후 닫기
        });

        // ===== 모달 열기 =====
        $('#navlist1').click(function () {
            $('#modal-overlay').css("display", "flex"); // 모달 표시
        });

        // ===== 모달 닫기 =====
        $('#close-modal').click(function () {
            $('#modal-overlay').css("display", "none"); // 모달 숨김
        });

        // ===== 모달 내 form 기본 제출 막기 =====
        $("#modal-form").on("submit", function (e) {
            e.preventDefault(); // 페이지 리로드 방지
        });


        $.ajax({
            url: "/messages/departments",
            method: "get",
            success: function (departments) {
                let $deptMenu = $("#modaldepartment .dropdown-menu");
                $deptMenu.empty();
                departments.forEach(dep => {
                    $deptMenu.append(`<a href="#" class="dept-option">${dep}</a>`);
                });
            }
        });
        $(document).on("click", ".dept-option", function (e) {
            let selectedDep = $(this).text();
            $("#modaldepartment .dropdown-btn").text(selectedDep);

            $.ajax({
                url: "/messages/userByDepartment",
                method: "get",
                data: {department: selectedDep},
                success: function (users) {
                    let $nameMenu = $("#modalname .dropdown-menu");
                    $nameMenu.empty();
                    users.forEach(user => {
                        $nameMenu.append(`<a href="#" class="user-option" data-userid="${user.id}">${user.name}</a>`);
                    });

                }
            });
        });

        let selectedUserId = null;
        $(document).on("click", ".user-option", function () {
            let name = $(this).text();
            let userId = $(this).data("userid");
            selectedUserId = $(this).data("userid");
            $("#modalname .dropdown-btn").text(name);
            $("#selectedUserId").val(userId); // ✅ 여기 고침
            console.log("선택한 이름:", name);
            console.log("선택한 ID:", userId);
        });


        $(document).on("click", "#submit-modal", function (e) {

            const selectedUserId = $("#selectedUserId").val();
            const title = $("#modaltitle").val();
            const content = $("#modalsection").val();
            console.log(selectedUserId, title, content);
            if (!selectedUserId || !title || !content) {
                alert("모든 항목을 작성해주세요.");
                return;
            }
            loadMessage("all")
            // AJAX 요청 보내기
            $.ajax({
                url: "/messages/createMessage",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    receiverId: selectedUserId,
                    title: title,
                    content: content
                }),
                success: function (response) {
                    alert("쪽지를 보냈습니다.");
                    // 모달 닫고 초기화
                    $("#modal-overlay").hide();
                    $("#modaltitle").val("");
                    $("#modalsection").val("");
                    $("#selectedUserId").val("");
                    $("#selectedUserName").text("이름 선택");
                },
                error: function () {
                    alert("쪽지 보내기에 실패했습니다.");
                }
            });
        })
        loadMessages("all");

        // 카테고리 필터 선택 시
        $(document).on("click", ".dropdown-menu a", function () {
            const filter = $(this).data("filter");
            $(this).closest(".dropdown").find(".dropdown-btn").text($(this).text());
            loadMessages(filter);
        });

        // 중요 표시 토글
        $(document).on("click", ".important-icon", function (e) {
            e.stopPropagation();
            const icon = $(this);
            const messageId = icon.data("id");
            const isNowImportant = icon.hasClass("bi-star-fill");

            $.ajax({
                url: `/messages/important/${messageId}`,
                method: "POST",
                data: { isImportant: !isNowImportant },
                success: function () {
                    icon.toggleClass("bi-star bi-star-fill");
                },
                error: function () {
                    alert("중요 표시 변경 실패");
                },
            });
        });

        // 메시지 클릭 시 상세 보기 표시
        $(document).on("click", ".getmessage", function () {
            const $this = $(this);
            const messageId = $this.data("id");

            $("#rightmaintitle").text($this.data("title"));
            $("#rightmaincontents").text($this.data("content"));
            $("#profilename").text($this.data("name"));
            $("#writedate").text($this.data("date"));

            $.ajax({
                url: `/messages/read/${messageId}`,
                method: "POST",
                success: function () {
                    $this.removeClass("unread").addClass("read");
                    $this.find(".getmessage_first > div:first-child").css("font-weight", "normal");
                }
            });
        });

        function loadMessages(filter) {
            $.ajax({
                url: "/messages/list",
                data: { receiverId: receiverId },
                method: "GET",
                success: function (data) {
                    const container = $(".messages");
                    container.empty();

                    let filtered = data;
                    if (filter === "unread") filtered = data.filter((m) => !m.isRead);
                    else if (filter === "important") filtered = data.filter((m) => m.isImportant);

                    if (filtered.length === 0) {
                        container.append(`<div class="placeholder">📭 해당 조건의 쪽지가 없습니다.</div>`);
                        return;
                    }

                    $("#totalcount").text(`총 ${filtered.length}개의 쪽지가 있습니다.`);

                    filtered.forEach((msg) => {
                        const isRead = msg.isRead;
                        const isImportant = msg.isImportant;
                        const starIcon = isImportant ? "bi-star-fill" : "bi-star";
                        const readClass = isRead ? "read" : "unread";
                        const title = msg.title ?? "제목 없음";
                        const date = formatDate(msg.createdAt);
                        const sender = msg.senderName ?? "알 수 없음";
                        const content = msg.content.length > 30 ? msg.content.slice(0, 30) + "..." : msg.content;

                        const html = `
                                <div class="getmessage ${readClass}"
                                    data-id="${msg.id}"
                                    data-title="${title}"
                                    data-date="${date}"
                                    data-name="${sender}"
                                    data-content="${msg.content}"
                                    data-important="${isImportant}">

                                  <div class="getmessage_first" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: ${isRead ? "normal" : "bold"}; font-size: 16px;">${title}</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                      <i class="bi ${starIcon} important-icon" data-id="${msg.id}" style="cursor: pointer;"></i>
                                      <div style="font-size: 12px; color: gray;">${date}</div>
                                    </div>
                                  </div>
                                  <div style="font-size: 13px; color: #444;">${sender}</div>
                                  <div style="font-size: 13px; color: #666;">${content}</div>
                                </div>
                              `;

                        container.append(html);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("🔥 AJAX 오류 발생 🔥");
                    console.log("상태 코드:", xhr.status);
                    console.log("응답 텍스트:", xhr.responseText);
                    console.log("에러 메시지:", error);
                },
            });
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getFullYear().toString().slice(2)}.${d.getMonth() + 1}.${d.getDate()}`;
        }

    });


</script>
</body>
</html>