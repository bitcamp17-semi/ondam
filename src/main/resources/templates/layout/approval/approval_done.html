<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>전자결재</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/approval_done.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">
                전자결재
            </div>
            <div class="mainnavbar">
                <div id="navlist1">+ 작성하기</div>
                <div class="navlistnone" id="inbox">수신함</div>
                <div class="navlistnone" id="outbox">발신함</div>
                <div id="navlist2">결재완료</div>
            </div>
        </div>
        <div class="section">
            <div class="btnset">
                <div class="btnset">
                    <label><input type="radio" name="approvalType" value="sent" checked> 발신함</label>
                    <label><input type="radio" name="approvalType" value="received"> 수신함</label>
<!--                    <button class="whitebtn">선택 삭제</button>-->
                </div>
            </div>
            <!-- 승인 리스트 영역 (비어있을 때 메시지 포함) -->
            <div class="approvallist">
                <div class="listtop" id="listHeader">
                    <!-- 여기에 수/발신에 따른 리스트명 채워짐 -->
                </div>
                <div class="listmain" id="approvalList">
                    <!-- 여기에 ajax로 항목 채워짐 -->
                </div>
                <div id="emptyMessage" style="display:none; padding: 20px; color: #999; text-align: center;">
                    결재 내역이 없습니다.
                </div>
            </div>
            <div class="pagenumset">
                <i class="bi bi-arrow-left leftbtn page-arrow"></i>
                <div class="pagenum">
                    <!-- page 부분 -->
                </div>
                <i class="bi bi-arrow-right rightbtn page-arrow"></i>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<script>
    $(document).ready(function () {
        let currentPage = 1;
        let currentType = 'sent';
        const pageSize = 10;
        loadList(currentType, currentPage); // 초기 호출

        $('input[name="approvalType"]').on('change', function () {
            currentType = $(this).val();
            currentPage = 1;
            loadList(currentType, currentPage);
        });


        function updateHeader(type) {
            const header = $('#listHeader');
            if (type === 'sent') {
                header.html(`
            <div class="list-cell">번호</div>
            <div class="list-cell listtitle">제목</div>
            <div class="list-cell">문서분류</div>
            <div class="list-cell">작성일</div>
            <div class="list-cell">결재상태</div>
        `);
            } else {
                header.html(`
            <div class="list-cell2">번호</div>
            <div class="list-cell2 listtitle">제목</div>
            <div class="list-cell2">발신자</div>
            <div class="list-cell2">문서분류</div>
            <div class="list-cell2">작성일</div>
            <div class="list-cell2">결재상태</div>
        `);
            }
        }

        function loadList(type, page) {
            currentType = type;
            const url = type === 'sent' ? '/api/draft/sentDoneList' : '/api/draft/receivedDoneList';

            $.ajax({
                url,
                type: 'GET',
                data: { page, size: pageSize },
                success: function (res) {
                    if (res.status === 'ok') {
                        const list = res.result.list;
                        const totalCnt = res.result.totalCnt;
                        const totalPages = Math.ceil(totalCnt / pageSize);

                        updateHeader(type);
                        renderList(list, type);
                        renderPagination(totalPages, page);
                    }
                },
                error: function () {
                    alert('목록 조회 실패');
                }
            });
        }

        function renderList(data, type) {
            const listMain = $('#approvalList');
            listMain.empty();

            if (!data || data.length === 0) {
                $('#emptyMessage').show();
                return;
            }

            $('#emptyMessage').hide();

            data.forEach((item, index) => {
                const createdDate = item.createdAt?.split(' ')[0] ?? '';
                const statusText = item.status === 'APPROVED' ? '승인' : '반려';

                const html = type === 'sent'
                    ? `
                <div class="listcontent row-item" data-id="${item.id}">
                    <div class="list-cell">${item.id}</div>
                    <div class="list-cell listtitle">${item.title}</div>
                    <div class="list-cell">${item.templateTitle ?? '-'}</div>
                    <div class="list-cell">${createdDate}</div>
                    <div class="list-cell">${statusText}</div>
                </div>
            `
                    : `
                <div class="listcontent row-item" data-id="${item.id}">
                    <div class="list-cell2">${item.id}</div>
                    <div class="list-cell2 listtitle">${item.title}</div>
                    <div class="list-cell2">${item.authorName}</div>
                    <div class="list-cell2">${item.templateTitle ?? '-'}</div>
                    <div class="list-cell2">${createdDate}</div>
                    <div class="list-cell2">${statusText}</div>
                </div>
            `;

                listMain.append(html);
            });

            // ✅ 클릭 이벤트 바인딩
            $('.row-item').off('click').on('click', function () {
                const draftId = $(this).data('id');
                window.location.href = `/draft/approvalDoneFile/${draftId}`;
            });
        }

        function renderPagination(totalPages, page) {
            let pageNumContainer = $(".pagenum");
            pageNumContainer.empty();

            for (let i = 1; i <= totalPages; i++) {
                let pageDiv = $(`<div>${i}</div>`);
                if (i === page) {
                    pageDiv.addClass("currentPage");
                } else {
                    pageDiv.addClass("otherPage");
                }

                pageDiv.on("click", function () {
                    currentPage = i;
                    loadList(currentType, i); // ✅ 올바른 함수 호출
                });

                pageNumContainer.append(pageDiv);
            }

            $(".leftbtn").off("click").on("click", function () {
                if (currentPage > 1) {
                    currentPage--;
                    loadList(currentType, currentPage);
                }
            });

            $(".rightbtn").off("click").on("click", function () {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadList(currentType, currentPage);
                }
            });
        }
    });
</script>
<script>
    $("#navlist1").click(function () {
        location.href = "/draft/approvalWrite";
    })
    $("#inbox").click(function () {
        location.href = "/draft/approvalInbox";
    })
    $("#outbox").click(function () {
        location.href = "/draft/approvalOutBox";
    })
    $("#navlist2").click(function () {
        location.href = "/draft/approvalDone";
    })
</script>