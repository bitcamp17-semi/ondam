<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>전자결재</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/approval_inbox_file.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">
                전자결재
            </div>
            <div class="navbar">
                <div id="navlist1">+ 작성하기</div>
                <div class="navlistnone" id="inbox">수신함</div>
                <div id="navlist2">발신함</div>
                <div class="navlistnone" id="donebox">결재완료</div>
            </div>
        </div>
        <div class="section">
            <div class="btnset">
                <button class="whitebtn">< 목록보기</button>
                <button class="whitebtn" id="download-btn">첨부파일 다운로드</button>
            </div>
            <div class="approvallist">
                <div class="listtop">
                    <div class="list-cell">제목</div>
                    <div class="list-cell">결재상태</div>
                    <div class="list-cell">작성일</div>
                </div>
                <div id="readonly-content">
                    <!-- 여기에 결재문서 출력 -->
                </div>
                <div class="approvalline">
                    <div class="profileset">
                        <!-- 여기에 결재라인 출력 -->
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const draftId = window.location.pathname.split("/").pop(); // 마지막 경로값
        loadDraftDetail(draftId);
    });
    document.addEventListener('DOMContentLoaded', () => {
        // 예시 문서 출력
        const savedHtml = `<h1>출장 신청서</h1>
            <p>일자: 4월 10일 ~ 4월 12일</p><p>장소: 부산</p>`;
        $('#readonly-content').html(savedHtml);

        // 테스트용 결재라인
        const approvalLine = [
            { name: "김대리", rank: "대리", imgUrl: "/img/profile1.png", status: "승인" },
            { name: "이과장", rank: "과장", imgUrl: "/img/profile2.png", status: "반려", rejectReason: "출장 사유 불명확" },
        ];
        renderApprovalLine(approvalLine);

        // 첨부파일 다운로드
        $('#download-btn').on('click', () => {
            alert('첨부파일 다운로드 처리');
            // window.location.href = '/api/approval/download?approvalId=123';
        });

        // 결재라인 렌더링
        function renderApprovalLine(data) {
            const container = $('.approvalline');
            container.empty();

            data.forEach(user => {
                const isRejected = user.status === 'REJECTED';
                const tooltipText = isRejected ? (user.rejectReason || '사유 없음') : '';

                const profile = `
                    <div class="profileset">
                        <div class="lineprofile">
                            <img src="${user.imgUrl}">
                            <span>${user.name}${user.rank}</span>
                        </div>
                        <div class="linebtn ${user.status === '승인' ? 'approved' : isRejected ? 'rejected' : ''}">
                            ${user.status}
                        </div>
                    </div>
                    ${isRejected ? `
                        <div class="reject-reason-box" style="display:none;">
                            반려 사유: ${tooltipText}
                        </div>
                    ` : ''}
                `;
                container.append(profile);
            });

            // 반려 상태일 때 사유 토글
            $('.linebtn.rejected').off('click').on('click', function () {
                const reasonBox = $(this).closest('.profileset').next('.reject-reason-box');
                reasonBox.slideToggle(200);
            });
        }
    });
    function loadDraftDetail(id) {
        $.ajax({
            url: "/api/draft/readDraft",
            data: { id },
            type: "GET",
            success: function (res) {
                if (res.status === "ok") {
                    const draft = res.result.draft;
                    const approvals = res.result.approvals;
                    const logs = res.result.approvalsLog;

                    // ✏️ 여기서 화면에 draft 정보, 결재자 목록, 로그를 그려야 함
                    $("#title").text(draft.title);
                    $("#content").html(draft.content);

                    renderApprovalList(approvals);
                    renderApprovalLog(logs);
                }
            },
            error: function () {
                alert("기안문 정보 로딩 실패");
            }
        });
    }

    function renderApprovalList(approvals) {
        approvals.forEach(a => {
            $("#approvers").append(`<div>${a.userId} / 순서: ${a.order}</div>`);
        });
    }

    function renderApprovalLog(logs) {
        logs.forEach(l => {
            $("#logs").append(`<div>${l.action} / 사유: ${l.reason}</div>`);
        });
    }
</script>
</body>
</html>
<script>
    $("#navlist1").click(function () {
        location.href = "/draft/approvalWrite";
    })
    $("#inbox").click(function () {
        location.href = "/draft/approvalInbox";
    })
    $("#navlist2").click(function () {
        location.href = "/draft/approvalOutBox";
    })
    $("#donebox").click(function () {
        location.href = "/draft/approvalDone";
    })
</script>