<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>전자결재</title>
    <link rel="stylesheet" th:href="@{/style/globals.css}"/>
    <link rel="stylesheet" th:href="@{/style/approval_inbox_file.css}"/>
    <link rel="stylesheet" th:href="@{/style/header.css}"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
<div class="fullbox">
    <div th:replace="~{layout/header :: header}"></div>
    <div class="main">
        <div class="nav">
            <div class="navtitle">
                전자결재
            </div>
            <div class="navbar">
                <div id="navlist1">+ 작성하기</div>
                <div id="navlist2">수신함</div>
                <div class="navlistnone" id="outbox">발신함</div>
                <div class="navlistnone" id="donebox">결재완료</div>
            </div>
        </div>
        <div class="section">
            <div class="btnset">
                <button class="whitebtn" id="list-btn">< 목록보기</button>
                <button class="whitebtn" id="reject-btn">반려하기</button>
                <button class="whitebtn" id="download-btn">첨부파일 다운로드</button>
                <span class="file-name">첨부파일 없음</span>
                <button class="orangebtn" id="approve-btn">결재승인</button>
            </div>
            <div class="approvallist">
                <div class="listtop">
                    <div class="list-cell" id="title"></div>
                    <div class="list-cell" id="author"></div>
                    <div class="list-cell" id="date"></div>
                </div>
                <div id="readonly-content">
                    <!-- 여기에 결재문서 출력 -->
                </div>
                <div class="approvalline">
                <!-- 결재 라인 영역 -->
                </div>

            </div>
        </div>
    </div>
</div>
<!-- 반려 사유 입력 모달 -->
<div id="reject-modal" class="modal-bg" style="display: none;">
    <div class="modal-box">
        <h3>반려 사유 입력</h3>
        <textarea id="reject-reason" rows="5" placeholder="반려 사유를 입력해주세요.(최대5줄)"></textarea>
        <div class="modal-btns">
            <button id="cancel-reject" class="whitebtn">취소</button>
            <button id="confirm-reject" class="orangebtn">반려</button>
        </div>
    </div>
</div>

<script>
    const storageUrl = "https://kr.object.ncloudstorage.com/bitcamp-semi/";
    const draftId = window.location.pathname.split("/").pop(); // 마지막 경로값
    $(document).ready(function () {
        loadDraftDetail(draftId);

        // 목록보기 버튼
        $("#list-btn").on("click", function () {
            toList();
        })

        // 승인 버튼 클릭
        $('#approve-btn').on('click', () => {
            if (confirm("승인하시겠습니까?")) {
                $.ajax({
                    url: "/api/draft/checkOrder",
                    type: "get",
                    data: {draftId},
                    success: function (res) {
                        if (res.status === "ok") {
                            $.ajax({
                                url: "/api/draft/"+draftId+"/actions",
                                type: "get",
                                data: {action: "APPROVED"},
                                success: function (res) {
                                    if (res.status === "ok") {
                                        alert('승인되었습니다!');
                                        toList();
                                    }
                                }
                            })
                        } else {
                            alert("현재 결재 대상자가 아닙니다.");
                            toList();
                        }
                    },
                    error: function () {
                        alert("현재 결재 대상자가 아닙니다.");
                        toList();
                    }
                })
            }
        });

        // 반려 버튼 클릭 → 모달 표시
        $('#reject-btn').on('click', () => {
            $('#reject-modal').fadeIn(200);
        });

        // 모달 내 취소
        $('#cancel-reject').on('click', () => {
            $('#reject-modal').fadeOut(200);
        });

        // 모달 내 확인 (반려 처리)
        $('#confirm-reject').on('click', () => {
            const reason = $('#reject-reason').val().trim();
            if (reason === '') {
                alert('반려 사유를 입력해주세요.');
                return;
            }
            if (confirm("반려하시겠습니까?")) {
                $.ajax({
                    url: "/api/draft/checkOrder",
                    type: "get",
                    data: {draftId},
                    success: function (res) {
                        if (res.status === "ok") {
                            $.ajax({
                                url: "/api/draft/"+draftId+"/actions",
                                type: "get",
                                data: {action: "REJECTED", reason: reason},
                                success: function (res) {
                                    if (res.status === "ok") {
                                        alert('반려 처리되었습니다.\n사유: ' + reason);
                                        $('#reject-modal').fadeOut(200);
                                        toList();
                                    }
                                }
                            })
                        } else {
                            alert("현재 결재 대상자가 아닙니다.");
                            toList();
                        }
                    },
                    error: function () {
                        alert("현재 결재 대상자가 아닙니다.");
                        toList();
                    }
                })
            }

            $('#approve-btn').prop('disabled', true);
            $('#reject-btn').prop('disabled', true);
        });

        // 첨부파일 다운로드
        $('#download-btn').on('click', () => {
            $.ajax({
                url: `/api/draft/readDraft`,
                data: { id: draftId },
                type: "GET",
                success: function (res) {
                    const files = res.result.files;
                    if (!files || files.length === 0) {
                        alert("첨부파일이 없습니다.");
                        return;
                    }

                    if (files.length >= 4) {
                        window.location.href = `/api/draft/downloadAll/${draftId}`;
                    } else {
                        files.forEach(file => {
                            const a = document.createElement('a');
                            a.href = `/api/draft/downloadFile/${file.id}`;
                            a.download = file.name;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        });
                    }
                },
                error: function () {
                    alert("파일 정보를 불러오는 데 실패했습니다.");
                }
            });
        });



    });

    function loadDraftDetail(id) {
        $.ajax({
            url: "/api/draft/readDraft",
            data: {id},
            type: "GET",
            success: function (res) {
                if (res.status === "ok") {
                    const draft = res.result.draft;
                    if (draft.status !== "PENDING") {
                        location.href = "/draft/approvalDoneFile/" + draftId;
                    }
                    const approvals = res.result.approvals;
                    const logs = res.result.approvalsLog;
                    const files = Array.isArray(res.result.files)
                        ? res.result.files
                        : [res.result.files];
                    window.attachedFiles = files;
                    const names = files.map(f => f.name); // 파일 이름 배열
                    let finalText = '';
                    if (files.length <= 4) {
                        finalText = names.join(', ');
                    } else {
                        finalText = names.slice(0, 4).join(', ') + ` 외 ${files.length - 4}개`;
                    }

                    if (draft.status === "APPROVED" || draft.status === "REJECTED") {
                        location.href = "/draft/approvalDoneFile/" + draftId;
                    }

                    const currentUserId = parseInt($("#header-profileImage").data("id"));
                    const userIsApprover = approvals.some(a => a.userId === currentUserId);
                    if (!userIsApprover) {
                        alert("접근 권한이 없습니다.");
                        history.back();
                        return;
                    }

                    const approvalLine = approvals.map(a => ({
                        userId: a.userId,
                        name: a.userName,
                        position: a.position,
                        imgUrl: a.profileImage ? (storageUrl + "users/" + a.profileImage) : "../../images/Rectangle53.png",
                        status: a.status // 예: "PENDING", "APPROVED", "REJECTED"
                    }));
                    // 문서 내용
                    $("#title").text(draft.title);
                    $("#author").text(draft.authorName)
                    $("#date").text(draft.createdAt.split(" ")[0]);
                    $("#readonly-content").html(draft.content);
                    $('.file-name').text(`${finalText} (${files.length})`);




                    renderApprovalLine(approvalLine, logs);
                }
            },
            error: function () {
                alert("기안문 정보 로딩 실패");
            }
        });
    }

    // 결재라인 렌더링 함수
    function renderApprovalLine(data, logs) {
        const container = $('.approvalline');
        container.empty();

        data.forEach(user => {
            const isRejected = user.status === 'REJECTED';
            const userLog = logs.find(l => l.approvalId === user.userId && l.action === 'REJECTED');
            const tooltipText = isRejected && userLog ? (userLog.reason || '사유 없음') : '';

            const profile = `
            <div class="profileset">
                <div class="lineprofile">
                    <img src="${user.imgUrl}">
                    <span>${user.name} ${user.position}</span>
                </div>
                <div class="linebtn ${user.status === 'APPROVED' ? 'approved' : isRejected ? 'rejected' : ''}">
                    ${convertStatusText(user.status)}
                </div>
            </div>
            ${isRejected ? `
                <div class="reject-reason-box" style="display:none;">
                    반려 사유: ${tooltipText}
                </div>
            ` : ''}
        `;

            container.append(profile);
        });

        $('.linebtn.rejected').off('click').on('click', function () {
            const reasonBox = $(this).closest('.profileset').next('.reject-reason-box');
            reasonBox.slideToggle(200);
        });
    }

    function convertStatusText(status) {
        switch (status) {
            case 'PENDING':
                return '대기중';
            case 'APPROVED':
                return '승인';
            case 'REJECTED':
                return '반려';
            default:
                return '알 수 없음';
        }
    }

    function toList() {
        location.href = "/draft/approvalInbox";
    }
</script>
</body>
</html>
<script>
    $("#navlist1").click(function () {
        location.href = "/draft/approvalWrite";
    })
    $("#navlist2").click(function () {
        toList();
    })
    $("#outbox").click(function () {
        location.href = "/draft/approvalOutBox";
    })
    $("#donebox").click(function () {
        location.href = "/draft/approvalDone";
    })
</script>