<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>My Messenger</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/style/globals.css}" />
<link rel="stylesheet" th:href="@{/style/header.css}" />
<link rel="stylesheet" th:href="@{/style/chat.css}" />
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
	<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
</head>
<body>
	<div th:replace="~{layout/header :: header}"></div>
	<div class="fullbox">
		<div class="chat-container main">
			<div id='scheTitle' class="nav">
				<div class="navtitle">채팅</div>
			</div>
			<div class="section">
				<!-- Sidebar -->
				<div class="sidebar leftarticle">
					<div class="sidebar-header lefttop">
						My Messenger
						<button class="btn btn-primary groupbtn">그룹 채팅 생성</button>
					</div>

					<div class="tab-buttons">
						<button class="tab-button" onclick="switchTab('chats')"
							th:classappend="${activeTab == 'chats'} ? ' active'">채팅
						</button>
						<button class="tab-button" onclick="switchTab('contacts')"
							th:classappend="${activeTab == 'contacts'} ? ' active'">멤버
						</button>
					</div>

					<div class="chat-list" th:if="${activeTab == 'chats'}">
						<div class="chat-item" th:each="group : ${chatGroupsList}">
							<div class="chat-item-content"
								th:onclick="|openChat('${group.id}')|">
								<div th:text="${group.displayInitial}"></div>
								<div class="chat-info">
									<div class="chat-name" th:text="${group.displayName}"></div>
									<div class="chat-preview"
										th:text="${group.lastMessage} ?: '메시지 없음'"></div>
								</div>
							</div>
							<button class="invite-button"
								th:attr="data-group-id=${group.id},data-group-name=${group.displayName}"
								onclick="showInviteForm(event)">초대</button>
						</div>
					</div>

					<div class="contact-list" th:if="${activeTab == 'contacts'}">
						<div class="contact-item" th:each="contact : ${contacts}">
							<div class="contact-info"
								th:onclick="|openChat('${contact.id}')|">
								<img
									th:if="${contact.profileImage != null and contact.profileImage != ''}"
									th:src="${contact.profileImage}" alt="Profile Image"
									class="contact-avatar"
									style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
								<div
									th:unless="${contact.profileImage != null and contact.profileImage != ''}"
									class="contact-avatar"
									th:text="${#strings.substring(contact.name, 0, 1)}"></div>
								<div class="contact-name" th:text="${contact.name}"></div>
							</div>
							<form th:action="@{/chat/createPrivateChat}" method="post"
								style="display: inline;">
								<input type="hidden" name="targetUserId"
									th:value="${contact.id}" /> <input type="hidden"
									name="activeTab" th:value="${activeTab}" />
								<button type="submit"
									class="btn btn-sm btn-outline-primary private-chat-btn onechat"
									title="개인 채팅">1 대1 채팅</button>
							</form>
						</div>
					</div>
				</div>
				<!-- Chat Area -->
				<div class="chat-area">
					<div class="chat-content">
						<div class="chat-header" id="chatHeader">
							<!-- JavaScript로 동적으로 채팅방 이름 삽입 -->
							<h5 id="chatRoomName"></h5>
						</div>
						<div class="chat-messages" id="chatMessages"></div>
						<div class="no-chat-selected" id="noChatSelected"
							style="display: block;">채팅방을 선택하세요.</div>
						<div class="chat-input-area" id="chatInputArea"
							style="display: none;">
							<div class="input-group">
								<input type="text" id="messageInput" class="form-control"
									placeholder="메시지를 입력하세요" required />
								<button id="sendButton" class="btn btn-primary">전송</button>
								<button id="fileButton" class="btn btn-primary"
									style="background-color: blue;">파일</button>
								<input type="file" id="fileInput" style="display: none;" />
							</div>
						</div>
					</div>
				</div>				
			</div>
		</div>
	</div>
	<!-- 초대 폼 -->
	<div class="overlay" id="overlay"></div>
	<div class="invite-form" id="inviteForm">
		<form th:action="@{/chat/invite}" method="post">
			<input type="hidden" name="groupId" id="inviteGroupId" /> <input
				type="hidden" name="activeTab" th:value="${activeTab}" />
			<div class="input-group mb-2">
				<select name="userId" id="inviteUserId" class="form-control"
					required>
					<option value="" disabled selected>초대할 사용자 선택</option>
					<option th:each="contact : ${contacts}" th:value="${contact.id}"
						th:text="${contact.name}"></option>
				</select>
				<button type="submit" class="btn btn-primary">초대하기</button>
			</div>
			<div>
				<span>초대할 그룹: </span> <span id="inviteGroupName"></span>
			</div>
		</form>
	</div>

	<!-- 그룹 채팅 생성 모달 -->
	<div class="modal fade" id="createGroupModal" tabindex="-1"
		aria-labelledby="createGroupModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="createGroupModalLabel">그룹 채팅 생성</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<form th:action="@{/chat/createGroup}" method="post">
					<div class="modal-body">
						<div class="mb-3">
							<label for="groupName" class="form-label">그룹 이름</label> <input
								type="text" class="form-control" id="groupName" name="groupName"
								required>
						</div>
						<div class="mb-3">
							<label class="form-label">초대할 멤버</label>
							<div class="contact-list"
								style="max-height: 200px; overflow-y: auto;">
								<div class="contact-item" th:each="contact : ${contacts}">
									<input type="checkbox" th:name="invitedUserIds"
										th:value="${contact.id}"> <span
										th:text="${contact.name}"></span>
								</div>
							</div>
						</div>
						<input type="hidden" name="activeTab" th:value="${activeTab}" />
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">취소</button>
						<button type="submit" class="btn btn-primary">생성</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- 이미지 모달 -->
	<div class="modal fade" id="imageModal" tabindex="-1"
		aria-labelledby="imageModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="imageModalLabel">이미지 보기</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<img id="modalImage" src="" alt="Image Preview">
				</div>
				<div class="modal-footer">
					<button id="downloadButton" class="btn btn-primary">다운로드</button>
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<script th:inline="javascript">
        class ChatClient {
            static DESTINATIONS = {
                GROUP: '/app/chat.send.group',
                PRIVATE: '/app/chat.send.private'
            };

            static SUBSCRIPTIONS = {
                GROUP: (roomId) => `/topic/group/${roomId}`,
                PRIVATE: '/user/queue/private'
            };

            constructor(config = {}) {
                this.stompClient = null;
                this.userId = config.userId ?? 0;
                this.roomId = null;
                this.roomType = null;
                this.targetUserId = null;
                this.senderName = config.senderName ?? 'Unknown';
                this.connected = false;
                this.subscription = null;

                this.init();
            }

            init() {
                this.connect();
                this.setupEventListeners();
            }

            connect() {
                try {
                    const socket = new SockJS('/ws');
                    this.stompClient = Stomp.over(socket);

                    this.stompClient.debug = (str) => {
                        console.log('STOMP Debug: ' + str);
                    };

                    this.stompClient.connect(
                        {'userId': this.userId},
                        (frame) => {
                            this.connected = true;
                            console.log('WebSocket 연결 성공');
                            if (this.roomId) {
                                this.subscribe();
                            }
                        },
                        (error) => {
                            this.connected = false;
                            console.error('WebSocket 연결 실패:', error);
                            setTimeout(() => this.connect(), 5000);
                        }
                    );
                } catch (error) {
                    console.error('WebSocket 초기화 오류:', error);
                }
            }

            subscribe() {
                if (!this.roomId || !this.connected) {
                    console.warn('구독 불가: roomId 또는 연결 없음');
                    return;
                }
                if (this.subscription) {
                    this.subscription.unsubscribe();
                }
                const subscriptionPath = this.roomType === 'GROUP'
                    ? ChatClient.SUBSCRIPTIONS.GROUP(this.roomId)
                    : ChatClient.SUBSCRIPTIONS.PRIVATE;

                this.subscription = this.stompClient.subscribe(subscriptionPath, (message) => {
                    this.handleMessage(JSON.parse(message.body));
                });
            }

            handleMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) {
                    console.warn('메시지 컨테이너 없음');
                    return;
                }

                const isMyMessage = message.isMyMessage !== undefined
                    ? message.isMyMessage
                    : message.senderId == this.userId;

                const messageElement = this.createMessageElement(message, isMyMessage);
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            createMessageElement(message, isMyMessage) {
                const element = document.createElement('div');
                element.className = `message ${isMyMessage ? 'my-message' : ''}`;

                const time = new Date(message.createdAt || message.time || Date.now()).toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let content = '';
                if (message.file) {
                    const isImage = message.fileType?.startsWith('image/') || /\.(jpg|jpeg|png|gif)$/i.test(message.message);
                    if (isImage) {
                        content = `
                            <a href="javascript:void(0)" data-file-url="${message.file}" data-file-name="${message.message}" onclick="showImageModal(this)">
                                <img src="${message.file}" style="max-width: 200px; border-radius: 8px;" alt="${message.message}"
                                     onerror="this.onerror=null; this.src='/images/fallback-image.png';" />
                            </a>`;
                    } else {
                        content = `<a href="${message.file}" download="${message.message}">${message.message}</a>`;
                    }
                } else {
                    content = message.message || message.content || '';
                }

                element.innerHTML = `
                    <div class="message-avatar">${message.senderName?.charAt(0) || 'U'}</div>
                    <div class="message-content">
                        <div class="message-sender">${message.senderName || 'Unknown'}</div>
                        <div class="message-text">${content}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;

                return element;
            }

            sendMessage(content) {
                if (!this.isReadyToSend(content)) return;
                const message = this.createMessageObject(content);
                this.sendMessageToServer(message);
            }

            isReadyToSend(content) {
                if (!this.connected) {
                    console.warn("메시지 전송 불가: WebSocket 연결 안 됨");
                    return false;
                }
                if (!content || !content.trim()) {
                    console.warn("메시지 전송 불가: 내용이 비어 있음");
                    return false;
                }
                if (!this.userId || !this.roomId || !this.stompClient) {
                    console.error("메시지 전송 불가: 필수 속성 누락");
                    return false;
                }
                return true;
            }

            createMessageObject(content) {
                return {
                    senderId: this.userId,
                    senderName: this.senderName,
                    message: content,
                    time: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    groupId: this.roomType === 'GROUP' ? Number(this.roomId) : null,
                    roomId: Number(this.roomId),
                    roomType: this.roomType,
                    targetUserId: this.targetUserId ? Number(this.targetUserId) : null,
                    isMyMessage: true
                };
            }

            sendMessageToServer(message) {
                const destination = this.getDestination();
                try {
                    this.stompClient.send(destination,
                        {'content-type': 'application/json'},
                        JSON.stringify(message));
                } catch (error) {
                    console.error("메시지 전송 실패:", error);
                }
            }

            getDestination() {
                return this.roomType === 'GROUP'
                    ? `${ChatClient.DESTINATIONS.GROUP}/${this.roomId}`
                    : ChatClient.DESTINATIONS.PRIVATE;
            }

            async uploadFile(file) {
                if (!file) return;
                const formData = new FormData();
                formData.append("file", file);
                formData.append("roomId", this.roomId);
                formData.append("roomType", this.roomType);
                formData.append("senderId", this.userId);
                formData.append("senderName", this.senderName);

                try {
                    const response = await fetch('/chat/uploadFile', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) throw new Error(`HTTP 오류! 상태: ${response.status}`);
                    await response.json();
                } catch (error) {
                    console.error("파일 업로드 실패:", error);
                    alert("파일 업로드에 실패했습니다.");
                }
            }

            updateRoom(newRoomId, newRoomType, newTargetUserId) {
                this.roomId = Number(newRoomId);
                this.roomType = newRoomType;
                this.targetUserId = newTargetUserId ? Number(newTargetUserId) : null;
                if (this.connected) {
                    this.subscribe();
                }
            }

            setupEventListeners() {
                const input = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');
                const fileButton = document.getElementById('fileButton');
                const fileInput = document.getElementById('fileInput');

                if (input && sendButton) {
                    sendButton.addEventListener('click', () => {
                        this.sendMessage(input.value);
                        input.value = '';
                    });
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage(input.value);
                            input.value = '';
                        }
                    });
                }

                if (fileButton && fileInput) {
                    fileButton.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', () => {
                        const file = fileInput.files[0];
                        if (file) {
                            this.uploadFile(file);
                            fileInput.value = '';
                        }
                    });
                }
            }
        }

        let chatClient = null;

        async function openChat(chatId) {
            console.log('openChat 호출됨, chatId:', chatId);
            try {
                if (!chatClient) {
                    console.error('chatClient가 초기화되지 않음');
                    return;
                }

                // 채팅 데이터 가져오기
                const response = await fetch(`/chat/loadChat?chatId=${chatId}`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'}
                });
                if (!response.ok) throw new Error('채팅 로드 실패');
                const chatData = await response.json();
                console.log('채팅 데이터 로드됨:', chatData);

                // UI 즉시 갱신
                const messagesContainer = document.getElementById('chatMessages');
                const noChatMessage = document.getElementById('noChatSelected');
                const inputArea = document.getElementById('chatInputArea');
                const chatHeader = document.getElementById('chatHeader');
                const chatRoomName = document.getElementById('chatRoomName');

                // 채팅방 이름 업데이트
                if (chatRoomName) {
                    chatRoomName.textContent = chatData.roomName || '채팅방';
                }

                // 채팅 헤더 표시
                if (chatHeader) {
                    chatHeader.style.display = 'block';
                }

                if (messagesContainer) {
                    messagesContainer.innerHTML = ''; // 기존 메시지 지우기
                    if (chatData.messages && chatData.messages.length > 0) {
                        chatData.messages.forEach(msg => {
                            const isMyMessage = msg.senderId == chatClient.userId;
                            const messageElement = chatClient.createMessageElement(msg, isMyMessage);
                            messagesContainer.appendChild(messageElement);
                        });
                    } else {
                        console.log('메시지 없음');
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    console.warn('chatMessages 요소를 찾을 수 없음');
                }

                if (noChatMessage) {
                    noChatMessage.style.display = 'none';
                }
                if (inputArea) {
                    inputArea.style.display = 'block';
                }

                // WebSocket 방 정보 업데이트
                chatClient.updateRoom(chatData.roomId, chatData.roomType, chatData.targetUserId);

                // URL 업데이트 (리로드 없이)
                history.pushState(null, '', `/chat/main?activeTab=chats&chatId=${chatId}`);
            } catch (error) {
                console.error('채팅 로드 오류:', error);
                alert('채팅방을 불러오는데 실패했습니다.');
            }
        }

        function switchTab(tabName) {
            window.location.href = `/chat/main?activeTab=${tabName}`;
        }

        function showInviteForm(event) {
            event.stopPropagation();
            const groupId = event.target.getAttribute('data-group-id');
            const groupName = event.target.getAttribute('data-group-name');
            const inviteForm = document.getElementById('inviteForm');
            const groupIdInput = document.getElementById('inviteGroupId');
            const groupNameSpan = document.getElementById('inviteGroupName');
            const overlay = document.getElementById('overlay');

            document.querySelectorAll('.invite-form.active').forEach(form => {
                form.classList.remove('active');
            });
            document.querySelectorAll('.overlay.active').forEach(ov => {
                ov.classList.remove('active');
            });

            inviteForm.classList.add('active');
            overlay.classList.add('active');
            groupIdInput.value = groupId;
            groupNameSpan.textContent = groupName;

            overlay.addEventListener('click', () => {
                inviteForm.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        function showImageModal(element) {
            const fileUrl = element.getAttribute('data-file-url');
            const fileName = element.getAttribute('data-file-name');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = fileUrl;

            const downloadButton = document.getElementById('downloadButton');
            const newDownloadButton = downloadButton.cloneNode(true);
            downloadButton.parentNode.replaceChild(newDownloadButton, downloadButton);

            newDownloadButton.addEventListener('click', () => downloadFile(fileUrl, fileName));

            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        async function downloadFile(fileUrl, fileName) {
            try {
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error(`HTTP 오류! 상태: ${response.status}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('다운로드 실패:', error);
                alert('파일 다운로드에 실패했습니다.');
            }
        }

        document.querySelector('.groupbtn')?.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
            modal.show();
        });

        const chatClientConfig = {
            userId: Number(/*[[${userId}]]*/ 0) || 0,
            senderName: /*[[${session.user?.name}]]*/ 'Unknown' || 'Unknown'
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded 실행됨');
            try {
                chatClient = new ChatClient(chatClientConfig);
                console.log('chatClient 초기화 완료:', chatClientConfig);

                const urlParams = new URLSearchParams(window.location.search);
                const chatId = urlParams.get('chatId');
                if (chatId) {
                    console.log('chatId 발견:', chatId);
                    openChat(chatId);
                }
            } catch (error) {
                console.error('초기화 오류:', error);
            }
        });
    </script>
</body>
</html>