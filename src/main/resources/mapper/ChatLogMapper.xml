<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.ChatLogMapper">
	<!-- 💾 채팅 로그 저장 -->
	<insert id="createChatLog" parameterType="ChatLogDto">
		insert into chat_log
		(senderid, receiverid, groupid, message, createdat, file, fileType)
		values
		(#{senderId}, #{receiverId}, #{groupId}, #{message},
		#{createdAt}, #{file}, #{fileType})
	</insert>

	<!-- 📜 그룹 채팅 전체 메시지 조회 -->
	<select id="readAllLogsByGroupId" parameterType="long"
		resultType="ChatLogDto">
		SELECT id, senderid, message, file, filetype,
		createdat
		FROM
		chat_log
		WHERE groupid = #{groupId}
		ORDER BY createdat ASC
	</select>

	<!-- 📩 그룹 채팅 마지막 메시지 조회 -->
	<select id="readLastGroupMessage" parameterType="long"
		resultType="ChatLogDto">
		select * from chat_log
		where groupid = #{groupId}
		order by
		createdat desc
		limit 1
	</select>

	<!-- 👥 1:1 채팅 마지막 메시지 조회 -->
	<select id="readLastPrivateMessage" resultType="ChatLogDto">
		select * from
		chat_log
		where (senderid = #{userId1} and receiverid = #{userId2})
		or
		(senderid = #{userId2} and receiverid = #{userId1})
		order by createdat
		desc
		limit 1
	</select>

	<!-- 🗂 나와 채팅한 모든 유저와의 마지막 메시지 리스트 -->
	<select id="readAllPrivateChatsWithLastMessages"
		parameterType="long" resultType="ChatLogDto">
		select cl.*
		from (
		select *,
		case
		when
		senderid = #{userId} then receiverid
		else senderid
		end as targetUserId
		from chat_log
		where receiverid is not null
		and senderid != receiverid
		and (senderid = #{userId} or receiverid = #{userId})
		order by createdat
		desc
		) cl
		group by cl.targetUserId
	</select>
	<!-- 🧾 1:1 채팅 전체 메시지 조회 -->
	<select id="readAllPrivateLogs" resultType="ChatLogDto">
		SELECT * FROM
		chat_log
		WHERE (senderid = #{userId} AND receiverid = #{chatId})
		OR
		(senderid = #{chatId} AND receiverid = #{userId})
		ORDER BY createdat
		ASC
	</select>
	<select id="readAllPrivateLogsByChatId" parameterType="long"
		resultType="ChatLogDto">
		SELECT id, senderid AS senderId, receiverid AS receiverId, isread AS isRead,
		message, groupid AS groupId,
		createdat AS createdAt, room_type AS roomType, room_id AS roomId,
		target_user_id AS targetUserId,
		time, sender_name AS senderName, file, file_url AS fileUrl, file_name AS
		fileName, file_type AS fileType
		FROM chat_logs
		WHERE room_type = 'PRIVATE' AND room_id = #{chatId}
		ORDER BY createdat ASC
	</select>
	<select id="readPrivateChatById" resultType="ChatLogDto">
    SELECT * FROM chat_log 
    WHERE groupid = #{chatId} AND room_type = 'PRIVATE'
    LIMIT 1
</select>
</mapper>
