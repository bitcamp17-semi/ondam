<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.ApprovalsMapper">
	<resultMap id="ApprovalLogDto" type="data.dto.ApprovalLogDto">
    	<id property="id" column="id"/><!-- approval_log의 PK -->
    	<result property="approvalId" column="approvalId"/>
    	<result property="draftId" column="draftId"/>
    	<result property="action" column="action"/>
    	<result property="approvalTime" column="approvalTime"/>
    	<result property="order" column="order"/>
	</resultMap>
    <insert id="createApprovals" parameterType="ApprovalsDto">
        insert into approvals (
        <if test="draftId != null">draftId,</if>
        <if test="templateId != null">templateId,</if>
        userId, `order`
        ) values (
        <if test="draftId != null">#{draftId},</if>
        <if test="templateId != null">#{templateId},</if>
        #{userId}, #{order}
        )
    </insert>
    <update id="updateApprovalsStatus" parameterType="map">
        update approvals
        set status = #{status}
        where draftId = #{draftId}
          and userId = #{userId}
    </update>
    <select id="readApprovalsByDraft" parameterType="int" resultType="ApprovalsDto">
        select *
        from approvals
        where draftId = #{draftId}
    </select>
    <select id="readApprovalsByTemplate" parameterType="int" resultType="ApprovalsDto">
        select *
        from approvals
        where templateId = #{templateId}
    </select>
    <insert id="createApprovalLog" parameterType="ApprovalLogDto">
        insert into approval_log (approvalId, action, approvalTime)
        values #{approvalId}, #{action}, now()
    </insert>
    <select id="readApprovalLogByDraft" parameterType="map" resultMap="ApprovalLogDto">
        SELECT
        al.approvalId,
        al.draftId,
        al.action,
        al.approvalTime,
        a.`order`
        FROM approval_log al
        JOIN approvals a
        ON al.approvalId = a.userId
        AND al.draftId = a.draftId
        WHERE al.draftId = #{draftId};
    </select>
</mapper>