<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.AlarmMapper">
<!-- 알람 등록 -->
<insert id="insertAlarm" parameterType="AlarmDto">
	insert into alarm (type,isRead, userId,causedBy,content,createdAt)
	values (#{type},#{isRead},#{userId},#{causedBy},#{content},now())
</insert>

<!-- 받은 알람 모두 조회 -->
<select id="allAlarm" resultType="AlarmDto" parameterType="map">
 	select id,
           type,
           isRead,
           userId,
           causedBy,
           content,
           createdAt 
   from alarm 
   where userId=#{userId}
    <if test="type != null and type != ''">and type = #{type}</if>
   order by id desc LIMIT #{perPage} OFFSET #{startNum}
</select>

<!-- 받은 알람 개수 조회-->
<select id="countAllAlarm" resultType="int" parameterType="map">
	select count(*) from alarm where userId=#{userId}
    <if test="type != null and type != ''">and type = #{type}</if>
</select>

<!-- 읽지 않은 알람 조회 -->
<select id="unreadAlarm" resultType="AlarmDto" parameterType="map">
 	select id,
           type,
           isRead,
           userId,
           causedBy,
           content,
           createdAt
     from alarm 
     where userId=#{userId} and isRead=0
    <if test="type != null and type != ''">and type = #{type}</if>
     order by id desc LIMIT #{perPage} OFFSET #{startNum}
</select>

<!-- 읽지 않은 개수 조회-->
<select id="countUnreadAlarm" resultType="int" parameterType="map">
	select count(*) from alarm where userId=#{userId} and isRead=0
    <if test="type != null and type != ''">and type = #{type}</if>
</select>

<!-- 읽은 알람 조회 -->
<select id="readAlarm" resultType="AlarmDto" parameterType="map">
 	select id,
           type,
           isRead,
           userId,
           causedBy,
           content,
           createdAt
     from alarm 
     where userId=#{userId} and isRead=1
    <if test="type != null and type != ''">and type = #{type}</if>
     order by id desc LIMIT #{perPage} OFFSET #{startNum}
</select>

<!-- 읽은 알람 개수 조회-->
<select id="countReadAlarm" resultType="int" parameterType="map">
	select count(*) from alarm where userId=#{userId} and isRead=1
    <if test="type != null and type != ''">and type = #{type}</if>
</select>

<!-- 알람 확인여부 업데이트 -->
<update id="updateIsRead" parameterType="list">
	UPDATE alarm
    SET isRead = 1
    WHERE id IN
    <foreach collection="list" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</update>
<delete id="deleteAlarm" parameterType="list">
    delete from alarm
    WHERE id IN
    <foreach collection="list" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</delete>
</mapper>