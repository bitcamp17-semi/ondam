<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.DraftMapper">
    <insert id="createDraftTemplate" parameterType="DraftTemplatesDto" useGeneratedKeys="true" keyProperty="id">
        insert into draft_templates (title, authorId, content, createdAt)
        values (#{title}, #{authorId}, #{content}, now())
    </insert>
    <select id="readDraftTemplate" parameterType="int" resultType="DraftTemplatesDto">
        select *
        from draft_templates
        where id = #{id}
    </select>
    <select id="readAllDraftTemplate" parameterType="int" resultType="DraftTemplatesDto">
        select *
        from draft_templates
    </select>
    <update id="updateDraftTemplate" parameterType="DraftTemplatesDto">
        update draft_templates
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="content != null">content = #{content},</if>
            updatedAt = now()
        </set>
        where id = #{id}
    </update>
    <delete id="deleteDraftTemplate" parameterType="int">
        delete
        from draft_templates
        where id = #{id}
    </delete>
    <insert id="createDraft" parameterType="DraftsDto" useGeneratedKeys="true" keyProperty="id">
        insert into drafts (title, authorId, content, templateId)
        values (#{title}, #{authorId}, #{content}, #{templateId})
    </insert>
    <select id="readDraft" parameterType="int" resultType="DraftsDto">
        SELECT d.*, u.name AS authorName
        FROM drafts AS d
                 JOIN users AS u ON d.authorId = u.id
        WHERE d.id = #{id}
    </select>
    <select id="readAllDrafts" resultType="DraftsDto">
        select *
        from drafts
    </select>
    <delete id="updateDraftStatus" parameterType="map">
        update drafts
        set status = #{status}
        where id = #{id}
    </delete>
    <select id="readPendingDraftsForUser" resultType="DraftsDto" parameterType="map">
        SELECT d.*, u.name AS authorName
        FROM drafts d
                 JOIN approvals a ON d.id = a.draftId
                 JOIN users u ON d.authorId = u.id
        WHERE d.status = 'PENDING'
          AND a.userId = #{userId}
          AND a.status = 'PENDING'
          AND NOT EXISTS (SELECT 1
                          FROM approvals prev
                          WHERE prev.draftId = d.id
                            AND prev.`order` &lt; a.`order`
                            AND prev.status != 'APPROVED')
            LIMIT #{size}
        OFFSET #{offset}
    </select>
    <select id="readCountDraftsForActions" resultType="Integer" parameterType="map">
        SELECT count(*)
        FROM drafts d
                 JOIN approvals a ON d.id = a.draftId
                 JOIN users u ON d.authorId = u.id
        WHERE d.status = 'PENDING'
          AND a.userId = #{userId}
          AND a.status = 'PENDING'
          AND NOT EXISTS (SELECT 1
                          FROM approvals prev
                          WHERE prev.draftId = d.id
                            AND prev.`order` &lt; a.`order`
                            AND prev.status != 'APPROVED')
    </select>
    <select id="readCheckIsOrder" parameterType="map" resultType="Integer">
        SELECT count(*)
        FROM drafts d
                 JOIN approvals a ON d.id = a.draftId
                 JOIN users u ON d.authorId = u.id
        WHERE d.status = 'PENDING'
          AND d.id = ${draftId}
          AND a.userId = #{userId}
          AND a.status = 'PENDING'
          AND NOT EXISTS (SELECT 1
                          FROM approvals prev
                          WHERE prev.draftId = d.id
                            AND prev.`order` &lt; a.`order`
                            AND prev.status != 'APPROVED')
    </select>


</mapper>